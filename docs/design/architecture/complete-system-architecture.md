# å®Œæ•´ç³»ç»Ÿæ¶æ„æ–¹æ¡ˆ
## å¤šå£°é“AIèŠå¤©ç³»ç»Ÿ + LLMè®­ç»ƒæ¥å£

---

## ğŸ“ æ€»ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        æ¸¸æˆäº‹ä»¶è§¦å‘                               â”‚
â”‚              (å‡ºç‰Œã€å‘ç‰Œã€å¾—åˆ†ã€å¯¹éª‚ç­‰)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    LLMèŠå¤©å¤„ç†æœåŠ¡å±‚                              â”‚
â”‚                  (ChatProcessingService)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æç¤ºè¯é¢„å¤„ç†  â”‚    â”‚  LLMè°ƒç”¨æ¥å£  â”‚    â”‚ è¿”å›ä¿¡æ¯åå¤„ç†â”‚
â”‚   Pipeline   â”‚â”€â”€â”€â–¶â”‚   Manager    â”‚â”€â”€â”€â–¶â”‚   Pipeline   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    è®­ç»ƒæ•°æ®æ”¶é›†å™¨                                â”‚
â”‚              (TrainingDataCollector)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èŠå¤©æ¶ˆæ¯è¾“å‡º                                  â”‚
â”‚                  (ChatMessage)                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
        â–¼                    â–¼                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æœ¬æ˜¾ç¤º    â”‚    â”‚  ç¿»è¯‘æœåŠ¡    â”‚    â”‚  å¤šå£°é“æ’­æ”¾  â”‚
â”‚  (æ°”æ³¡UI)    â”‚    â”‚ (Translation)â”‚    â”‚ (MultiChannel)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                    â”‚
                             â”‚                    â–¼
                             â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚          â”‚  é¢‘é“ç®¡ç†å™¨         â”‚
                             â”‚          â”‚ (ChannelManager)    â”‚
                             â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚                     â”‚
                             â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚          â”‚                     â”‚
                             â–¼          â–¼                     â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ ç©å®¶0é¢‘é“   â”‚ â”‚ ç©å®¶1é¢‘é“   â”‚ â”‚ ç©å®¶2é¢‘é“   â”‚
                    â”‚ (å·¦å£°é“)    â”‚ â”‚ (å³å£°é“)    â”‚ â”‚ (å·¦ä¸­)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶è®¾è®¡

### 1. LLMèŠå¤©å¤„ç†æœåŠ¡å±‚

#### 1.1 æç¤ºè¯é¢„å¤„ç†ç®¡é“ (Prompt Preprocessing Pipeline)

**åŠŸèƒ½ï¼š**
- æ–¹è¨€å¤„ç†ï¼šæ ¹æ®ç©å®¶æ–¹è¨€æ·»åŠ æ–¹è¨€æŒ‡ä»¤
- ä¸Šä¸‹æ–‡å¢å¼ºï¼šæ·»åŠ æ¸¸æˆçŠ¶æ€ã€å†å²è®°å½•
- æç¤ºè¯ä¼˜åŒ–ï¼šåŠ¨æ€è°ƒæ•´æç¤ºè¯æ¨¡æ¿
- æ¨¡æ¿æ¸²æŸ“ï¼šå¡«å……å˜é‡ï¼Œç”Ÿæˆæœ€ç»ˆæç¤ºè¯

**å¤„ç†å™¨åˆ—è¡¨ï¼š**
```typescript
1. DialectPromptProcessor      // æ–¹è¨€å¤„ç†ï¼ˆä¼˜å…ˆçº§ï¼š1ï¼‰
2. ContextEnhancerProcessor    // ä¸Šä¸‹æ–‡å¢å¼ºï¼ˆä¼˜å…ˆçº§ï¼š2ï¼‰
3. HistoryProcessor            // å†å²è®°å½•å¤„ç†ï¼ˆä¼˜å…ˆçº§ï¼š3ï¼‰
4. TemplateRendererProcessor   // æ¨¡æ¿æ¸²æŸ“ï¼ˆä¼˜å…ˆçº§ï¼š4ï¼‰
```

**ç¤ºä¾‹ï¼š**
```typescript
// è¾“å…¥ï¼šåŸºç¡€æç¤ºè¯ + ç©å®¶ä¿¡æ¯ï¼ˆå—æ˜Œè¯ï¼‰
// è¾“å‡ºï¼šå¢å¼ºåçš„æç¤ºè¯ï¼ˆåŒ…å«å—æ˜Œè¯æŒ‡ä»¤ï¼‰

åŸºç¡€æç¤ºè¯ï¼š
"ä½ æ˜¯ä¸€ä¸ªè¿‡ç‚¸ç‰Œæ¸¸æˆçš„AIç©å®¶..."

å¤„ç†åï¼š
"ä½ æ˜¯ä¸€ä¸ªè¿‡ç‚¸ç‰Œæ¸¸æˆçš„AIç©å®¶...

æ–¹è¨€è¦æ±‚ï¼ˆå—æ˜Œè¯ï¼‰ï¼š
- ä½¿ç”¨å—æ˜Œè¯è¡¨è¾¾ï¼Œä¾‹å¦‚ï¼š
  * "å¥½ç‰Œ" â†’ "æ°å™¶"
  * "è¦ä¸èµ·" â†’ "è¦ä¸åˆ°"
- ä¿æŒå£è¯­åŒ–ï¼Œç¬¦åˆå—æ˜Œè¯ç‰¹è‰²

æ¸¸æˆçŠ¶æ€ï¼š
- å½“å‰è½®æ¬¡ï¼šç¬¬3è½®
- ç©å®¶0å¾—åˆ†ï¼š150åˆ†
..."
```

---

#### 1.2 LLMè°ƒç”¨æ¥å£ç®¡ç†å™¨ (LLM Provider Manager)

**åŠŸèƒ½ï¼š**
- æ”¯æŒå¤šä¸ªLLMæä¾›è€…ï¼ˆOllamaã€OpenAIã€è‡ªå®šä¹‰ç­‰ï¼‰
- è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆFallbackï¼‰
- è¯·æ±‚é‡è¯•æœºåˆ¶
- æ€§èƒ½ç›‘æ§

**æä¾›è€…åˆ—è¡¨ï¼š**
```typescript
1. OllamaProvider        // æœ¬åœ°Ollamaï¼ˆé»˜è®¤ï¼‰
2. OpenAIProvider        // OpenAI APIï¼ˆå¯é€‰ï¼‰
3. CustomProvider        // è‡ªå®šä¹‰APIï¼ˆå¯é€‰ï¼‰
```

**è°ƒç”¨æµç¨‹ï¼š**
```typescript
1. æ£€æŸ¥æä¾›è€…å¯ç”¨æ€§
2. å‘é€è¯·æ±‚ï¼ˆå¸¦è¶…æ—¶æ§åˆ¶ï¼‰
3. å¦‚æœå¤±è´¥ï¼Œå°è¯•ä¸‹ä¸€ä¸ªæä¾›è€…
4. è®°å½•æ€§èƒ½æŒ‡æ ‡ï¼ˆå»¶è¿Ÿã€tokenæ•°ç­‰ï¼‰
```

---

#### 1.3 è¿”å›ä¿¡æ¯åå¤„ç†ç®¡é“ (Response Postprocessing Pipeline)

**åŠŸèƒ½ï¼š**
- å†…å®¹æ¸…ç†ï¼šç§»é™¤å†—ä½™ã€è¿‡é•¿å†…å®¹
- é•¿åº¦æ§åˆ¶ï¼šé™åˆ¶æœ€å¤§é•¿åº¦ï¼ˆ15å­—ï¼‰
- æ ¼å¼æ ‡å‡†åŒ–ï¼šç»Ÿä¸€æ ‡ç‚¹ã€æ ¼å¼
- ç¿»è¯‘å¤„ç†ï¼šæ ¹æ®UIè¯­è¨€ç¿»è¯‘
- æ–¹è¨€é€‚é…ï¼šç¡®ä¿æ–¹è¨€æ–‡æœ¬æ­£ç¡®

**å¤„ç†å™¨åˆ—è¡¨ï¼š**
```typescript
1. ContentCleanerProcessor     // å†…å®¹æ¸…ç†ï¼ˆä¼˜å…ˆçº§ï¼š1ï¼‰
2. LengthControllerProcessor   // é•¿åº¦æ§åˆ¶ï¼ˆä¼˜å…ˆçº§ï¼š2ï¼‰
3. FormatNormalizerProcessor   // æ ¼å¼æ ‡å‡†åŒ–ï¼ˆä¼˜å…ˆçº§ï¼š3ï¼‰
4. DialectAdapterProcessor     // æ–¹è¨€é€‚é…ï¼ˆä¼˜å…ˆçº§ï¼š4ï¼‰
5. TranslationProcessor        // ç¿»è¯‘å¤„ç†ï¼ˆä¼˜å…ˆçº§ï¼š5ï¼‰
```

**ç¤ºä¾‹ï¼š**
```typescript
// è¾“å…¥ï¼šLLMåŸå§‹è¿”å›
"å¥½çš„ï¼Œæˆ‘è§‰å¾—è¿™æ‰‹ç‰Œä¸é”™ï¼Œåº”è¯¥å¯ä»¥å‡ºã€‚"

// å¤„ç†æµç¨‹ï¼š
1. ContentCleaner: "è¿™æ‰‹ç‰Œä¸é”™ï¼Œåº”è¯¥å¯ä»¥å‡ºã€‚"
2. LengthController: "è¿™æ‰‹ç‰Œä¸é”™" (15å­—é™åˆ¶)
3. FormatNormalizer: "è¿™æ‰‹ç‰Œä¸é”™ï¼"
4. DialectAdapter: "æ°å™¶ï¼" (å¦‚æœæ˜¯å—æ˜Œè¯)
5. Translation: "Good hand!" (å¦‚æœUIæ˜¯è‹±æ–‡)

// è¾“å‡ºï¼šæœ€ç»ˆå†…å®¹
"æ°å™¶ï¼" æˆ– "Good hand!"
```

---

#### 1.4 è®­ç»ƒæ•°æ®æ”¶é›†å™¨ (Training Data Collector)

**åŠŸèƒ½ï¼š**
- æ”¶é›†å®Œæ•´å¤„ç†æµç¨‹æ•°æ®
- è®°å½•æ€§èƒ½æŒ‡æ ‡
- å¯¼å‡ºè®­ç»ƒæ•°æ®é›†
- è´¨é‡è¯„ä¼°

**æ•°æ®æ ¼å¼ï¼š**
```typescript
{
  // åŸºç¡€ä¿¡æ¯
  timestamp: number;
  playerId: number;
  eventType: string;
  
  // æç¤ºè¯ç›¸å…³
  originalPrompt: string;
  processedPrompt: string;
  promptProcessors: string[];
  
  // LLMç›¸å…³
  llmProvider: string;
  llmModel: string;
  rawContent: string;
  llmLatency: number;
  
  // å¤„ç†ç›¸å…³
  processedContent: string;
  responseProcessors: string[];
  processingTime: number;
  
  // ç»Ÿè®¡ä¿¡æ¯
  processingStats: {
    originalLength: number;
    processedLength: number;
    reduction: number;
    reductionPercent: number;
  };
  
  // ä¸Šä¸‹æ–‡
  context: {
    gameState: {...},
    eventData: {...},
    chatHistory: [...]
  }
}
```

**å¯¼å‡ºæ ¼å¼ï¼š**
- JSONLï¼ˆç”¨äºè®­ç»ƒï¼‰
- JSONï¼ˆç”¨äºåˆ†æï¼‰
- CSVï¼ˆç”¨äºExcelï¼‰

---

### 2. å¤šå£°é“è¯­éŸ³ç³»ç»Ÿ

#### 2.1 é¢‘é“ç®¡ç†å™¨ (Channel Manager)

**åŠŸèƒ½ï¼š**
- ç®¡ç†æ¯ä¸ªç©å®¶çš„ç‹¬ç«‹é¢‘é“
- å¤„ç†æ¶ˆæ¯é˜Ÿåˆ—
- æ§åˆ¶å¹¶å‘æ’­æ”¾
- éŸ³é‡æ··åˆ

**é¢‘é“åˆ†é…ï¼š**
```typescript
ç©å®¶0 â†’ ChannelType.PLAYER_0 (å·¦å£°é“, pan=-0.7)
ç©å®¶1 â†’ ChannelType.PLAYER_1 (å³å£°é“, pan=0.7)
ç©å®¶2 â†’ ChannelType.PLAYER_2 (å·¦ä¸­, pan=-0.3)
ç©å®¶3 â†’ ChannelType.PLAYER_3 (å³ä¸­, pan=0.3)
ç³»ç»Ÿ  â†’ ChannelType.ANNOUNCEMENT (ä¸­å¤®, pan=0.0)
```

**é˜Ÿåˆ—ç®¡ç†ç­–ç•¥ï¼š**
```typescript
1. æ¯ä¸ªé¢‘é“ç»´æŠ¤ç‹¬ç«‹é˜Ÿåˆ—
2. é«˜ä¼˜å…ˆçº§æ¶ˆæ¯å¯æ’é˜Ÿï¼ˆå¦‚å¯¹éª‚ï¼‰
3. æœ€å¤šåŒæ—¶æ’­æ”¾2-3ä¸ªé¢‘é“
4. å¦‚æœæ‰€æœ‰é¢‘é“éƒ½æƒ³æ’­æ”¾ï¼ŒæŒ‰æ—¶é—´ç‰‡è½®è½¬
```

---

#### 2.2 è¯­éŸ³æ’­æ”¾æœåŠ¡ (Voice Service)

**æŠ€æœ¯æ–¹æ¡ˆï¼š**
- ä½¿ç”¨æµè§ˆå™¨ `speechSynthesis` APIï¼ˆå…è´¹ï¼‰
- é€šè¿‡å‚æ•°å·®å¼‚åŒ–åŒºåˆ†ç©å®¶ï¼ˆè¯­é€Ÿã€éŸ³è°ƒã€éŸ³é‡ï¼‰
- é˜Ÿåˆ—ç®¡ç†é¿å…é‡å æ’­æ”¾
- æ—¶é—´é”™å¼€æ¨¡æ‹Ÿå¹¶å‘ï¼ˆ100-200mså»¶è¿Ÿï¼‰

**è¯­éŸ³å‚æ•°å·®å¼‚åŒ–ï¼š**
```typescript
ç©å®¶0: { rate: 1.0, pitch: 1.0, volume: 0.9 }   // æ­£å¸¸
ç©å®¶1: { rate: 1.1, pitch: 1.1, volume: 0.95 }  // ç¨å¿«ç¨é«˜
ç©å®¶2: { rate: 0.95, pitch: 0.9, volume: 0.85 }  // ç¨æ…¢ç¨ä½
ç©å®¶3: { rate: 1.05, pitch: 1.05, volume: 0.9 } // ç¨å¿«ç¨é«˜
```

**æ’­æ”¾æµç¨‹ï¼š**
```typescript
1. æ¥æ”¶èŠå¤©æ¶ˆæ¯ï¼ˆå·²å¤„ç†åçš„æ–‡æœ¬ï¼‰
2. æ£€æŸ¥é¢‘é“çŠ¶æ€ï¼ˆæ˜¯å¦æ­£åœ¨æ’­æ”¾ï¼‰
3. å¦‚æœç©ºé—²ï¼Œç«‹å³æ’­æ”¾
4. å¦‚æœå¿™ç¢Œï¼ŒåŠ å…¥é˜Ÿåˆ—
5. æ’­æ”¾æ—¶ä½¿ç”¨å¯¹åº”ç©å®¶çš„è¯­éŸ³å‚æ•°
```

---

#### 2.3 ç¿»è¯‘æœåŠ¡é›†æˆ (Translation Service)

**åŠŸèƒ½ï¼š**
- æ ¹æ®UIè¯­è¨€ç¿»è¯‘èŠå¤©å†…å®¹
- æ”¯æŒå¤šè¯­è¨€ï¼ˆä¸­æ–‡ã€è‹±æ–‡ã€éŸ©æ–‡ã€æ—¥æ–‡ç­‰ï¼‰
- ç¼“å­˜ç¿»è¯‘ç»“æœ

**ç¿»è¯‘æµç¨‹ï¼š**
```typescript
1. æ£€æŸ¥UIå½“å‰è¯­è¨€
2. å¦‚æœéä¸­æ–‡ï¼Œè°ƒç”¨ç¿»è¯‘API
3. ç¼“å­˜ç¿»è¯‘ç»“æœï¼ˆé¿å…é‡å¤ç¿»è¯‘ï¼‰
4. è¿”å›ç¿»è¯‘åçš„æ–‡æœ¬
```

**æ³¨æ„ï¼š**
- æ–¹è¨€æ–‡æœ¬ï¼ˆå¦‚å—æ˜Œè¯ï¼‰å…ˆç”¨æ™®é€šè¯TTSæ’­æ”¾
- å¦‚æœUIæ˜¯è‹±æ–‡ï¼Œç¿»è¯‘æˆè‹±æ–‡åå†æ’­æ”¾

---

## ğŸ¬ æ–‡å­—æ°”æ³¡ä¸è¯­éŸ³åŒæ­¥æ–¹æ¡ˆ

### è®¾è®¡ç›®æ ‡
- âœ… æ–‡å­—æ°”æ³¡ä¸è¯­éŸ³åŒæ—¶å¼€å§‹æ˜¾ç¤º/æ’­æ”¾
- âœ… æ–‡å­—æ°”æ³¡åœ¨è¯­éŸ³æ’­æ”¾å®Œæˆåè‡ªåŠ¨æ¶ˆå¤±
- âœ… æ”¯æŒè¯­éŸ³æ’­æ”¾çŠ¶æ€åé¦ˆï¼ˆæ’­æ”¾ä¸­åŠ¨ç”»ï¼‰
- âœ… å¤„ç†è¯­éŸ³æ’­æ”¾å¤±è´¥çš„æƒ…å†µ

### å®ç°æ–¹æ¡ˆ

#### 1. è¯­éŸ³æœåŠ¡æ‰©å±•ï¼ˆè¿”å›æ’­æ”¾äº‹ä»¶ï¼‰

```typescript
// src/services/voiceService.ts (æ‰©å±•)

interface SpeechPlaybackEvents {
  onStart?: () => void;      // è¯­éŸ³å¼€å§‹æ’­æ”¾
  onEnd?: () => void;        // è¯­éŸ³æ’­æ”¾å®Œæˆ
  onError?: (error: Error) => void;  // æ’­æ”¾å‡ºé”™
  estimatedDuration?: number; // é¢„ä¼°æ’­æ”¾æ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
}

class VoiceService {
  speak(
    text: string,
    voiceConfig?: VoiceConfig,
    playerId?: number,
    events?: SpeechPlaybackEvents  // æ–°å¢ï¼šæ’­æ”¾äº‹ä»¶å›è°ƒ
  ): Promise<void> {
    // è®¡ç®—é¢„ä¼°æ—¶é•¿
    const estimatedDuration = this.calculateDuration(text, voiceConfig);
    events?.onStart?.();  // é€šçŸ¥å¼€å§‹æ’­æ”¾
    
    return multiChannelVoiceService.speak(
      text,
      voiceConfig,
      channel,
      {
        onStart: events?.onStart,
        onEnd: events?.onEnd,
        onError: events?.onError,
        estimatedDuration
      }
    );
  }
  
  // è®¡ç®—è¯­éŸ³æ—¶é•¿ï¼ˆåŸºäºæ–‡æœ¬é•¿åº¦å’Œè¯­é€Ÿï¼‰
  private calculateDuration(text: string, voiceConfig?: VoiceConfig): number {
    const rate = voiceConfig?.rate || 1.0;
    // ä¸­æ–‡ï¼šçº¦0.3ç§’/å­—ï¼Œè‹±æ–‡ï¼šçº¦0.15ç§’/å­—
    const charsPerSecond = /[\u4e00-\u9fa5]/.test(text) ? 3.3 : 6.7;
    const baseDuration = (text.length / charsPerSecond) * 1000;
    return Math.ceil(baseDuration / rate);
  }
}
```

#### 2. èŠå¤©æ°”æ³¡ç»„ä»¶å¢å¼ºï¼ˆæ”¯æŒæ’­æ”¾çŠ¶æ€ï¼‰

```typescript
// src/components/ChatBubble.tsx (å¢å¼º)

interface ChatBubbleProps {
  message: ChatMessage;
  playerPosition: React.CSSProperties;
  isSpeaking?: boolean;        // æ–°å¢ï¼šæ˜¯å¦æ­£åœ¨æ’­æ”¾è¯­éŸ³
  onSpeechStart?: () => void;  // æ–°å¢ï¼šè¯­éŸ³å¼€å§‹å›è°ƒ
  onSpeechEnd?: () => void;    // æ–°å¢ï¼šè¯­éŸ³ç»“æŸå›è°ƒ
  onComplete?: () => void;
}

export const ChatBubble: React.FC<ChatBubbleProps> = ({
  message,
  playerPosition,
  isSpeaking = false,
  onSpeechStart,
  onSpeechEnd,
  onComplete
}) => {
  const [visible, setVisible] = useState(false);
  const [fadeOut, setFadeOut] = useState(false);
  const [speaking, setSpeaking] = useState(false);

  // ç›‘å¬è¯­éŸ³æ’­æ”¾çŠ¶æ€
  useEffect(() => {
    if (isSpeaking && !speaking) {
      // è¯­éŸ³å¼€å§‹æ’­æ”¾
      setSpeaking(true);
      setVisible(true);
      onSpeechStart?.();
    } else if (!isSpeaking && speaking) {
      // è¯­éŸ³æ’­æ”¾å®Œæˆ
      setSpeaking(false);
      // å¼€å§‹æ·¡å‡ºåŠ¨ç”»
      setFadeOut(true);
      onSpeechEnd?.();
      // æ·¡å‡ºå®Œæˆåéšè—
      setTimeout(() => {
        setVisible(false);
        onComplete?.();
      }, 1000); // æ·¡å‡ºåŠ¨ç”»1ç§’
    }
  }, [isSpeaking, speaking, onSpeechStart, onSpeechEnd, onComplete]);

  // å¦‚æœè¯­éŸ³æ’­æ”¾å¤±è´¥ï¼Œä½¿ç”¨è¶…æ—¶ä¿æŠ¤
  useEffect(() => {
    if (visible && !isSpeaking) {
      // å¦‚æœ3ç§’åè¿˜æ²¡æœ‰å¼€å§‹æ’­æ”¾ï¼Œæ˜¾ç¤ºæ°”æ³¡
      const showTimer = setTimeout(() => {
        if (!speaking) {
          setVisible(true);
        }
      }, 50);
      
      // å¦‚æœ10ç§’åè¿˜æ²¡æœ‰ç»“æŸï¼Œè‡ªåŠ¨éšè—ï¼ˆä¿æŠ¤æœºåˆ¶ï¼‰
      const hideTimer = setTimeout(() => {
        if (visible && !isSpeaking) {
          setFadeOut(true);
          setTimeout(() => {
            setVisible(false);
            onComplete?.();
          }, 1000);
        }
      }, 10000);
      
      return () => {
        clearTimeout(showTimer);
        clearTimeout(hideTimer);
      };
    }
  }, [visible, isSpeaking, speaking, onComplete]);

  if (!visible) return null;

  return (
    <div
      className={`chat-bubble ${fadeOut ? 'fade-out' : ''} ${message.type} ${speaking ? 'speaking' : ''}`}
      style={playerPosition}
    >
      <div className="chat-bubble-content">
        <div className="chat-bubble-name">{message.playerName}</div>
        <div className="chat-bubble-text">
          {message.content}
          {speaking && <span className="speaking-indicator">ğŸ”Š</span>}
        </div>
      </div>
      <div className="chat-bubble-arrow"></div>
    </div>
  );
};
```

#### 3. useChatBubbles Hook åè°ƒï¼ˆåŒæ­¥æ˜¾ç¤ºå’Œæ’­æ”¾ï¼‰

```typescript
// src/hooks/useChatBubbles.ts (å¢å¼º)

export function useChatBubbles(gameState: MultiPlayerGameState) {
  const [activeChatBubbles, setActiveChatBubbles] = useState<Map<number, ChatMessage>>(new Map());
  const [speakingStates, setSpeakingStates] = useState<Map<number, boolean>>(new Map());
  const lastMessageIdRef = useRef<string | null>(null);

  // ç›‘å¬èŠå¤©æ¶ˆæ¯å¹¶åŒæ­¥æ˜¾ç¤ºå’Œæ’­æ”¾
  useEffect(() => {
    const messages = getChatMessages();
    if (messages.length > 0) {
      const latestMessage = messages[messages.length - 1];
      const messageId = `${latestMessage.playerId}-${latestMessage.timestamp}`;
      
      if (lastMessageIdRef.current === messageId) {
        return;
      }
      lastMessageIdRef.current = messageId;
      
      const player = gameState.players.find(p => p.id === latestMessage.playerId);
      
      // ç¿»è¯‘æ¶ˆæ¯
      translateText(latestMessage.content, i18n.language || 'zh-CN')
        .then(translatedContent => {
          const translatedMessage: ChatMessage = {
            ...latestMessage,
            content: translatedContent
          };
          
          // å…ˆæ˜¾ç¤ºæ°”æ³¡ï¼ˆä½†ä¸å®Œå…¨æ˜¾ç¤ºï¼Œç­‰å¾…è¯­éŸ³å¼€å§‹ï¼‰
          setActiveChatBubbles(prev => {
            const newMap = new Map(prev);
            newMap.set(translatedMessage.playerId, translatedMessage);
            return newMap;
          });
          
          // æ’­æ”¾è¯­éŸ³ï¼Œå¹¶åŒæ­¥çŠ¶æ€
          if (player?.voiceConfig) {
            const voiceConfigForTaunt = translatedMessage.type === 'taunt' 
              ? { ...player.voiceConfig, volume: Math.min(1.0, (player.voiceConfig.volume || 1.0) * 1.5) }
              : player.voiceConfig;
            
            // è®¾ç½®æ’­æ”¾çŠ¶æ€
            setSpeakingStates(prev => {
              const newMap = new Map(prev);
              newMap.set(translatedMessage.playerId, true);
              return newMap;
            });
            
            // æ’­æ”¾è¯­éŸ³ï¼Œä¼ å…¥äº‹ä»¶å›è°ƒ
            voiceService.speak(
              translatedContent,
              voiceConfigForTaunt,
              translatedMessage.playerId,
              {
                onStart: () => {
                  // è¯­éŸ³å¼€å§‹ï¼Œç¡®ä¿æ°”æ³¡æ˜¾ç¤º
                  setSpeakingStates(prev => {
                    const newMap = new Map(prev);
                    newMap.set(translatedMessage.playerId, true);
                    return newMap;
                  });
                },
                onEnd: () => {
                  // è¯­éŸ³ç»“æŸï¼Œæ ‡è®°ä¸ºä¸æ’­æ”¾çŠ¶æ€ï¼ˆè§¦å‘æ·¡å‡ºï¼‰
                  setSpeakingStates(prev => {
                    const newMap = new Map(prev);
                    newMap.set(translatedMessage.playerId, false);
                    return newMap;
                  });
                },
                onError: (error) => {
                  console.warn('[useChatBubbles] è¯­éŸ³æ’­æ”¾å¤±è´¥:', error);
                  // æ’­æ”¾å¤±è´¥ï¼Œ3ç§’åè‡ªåŠ¨éšè—
                  setTimeout(() => {
                    setSpeakingStates(prev => {
                      const newMap = new Map(prev);
                      newMap.set(translatedMessage.playerId, false);
                      return newMap;
                    });
                  }, 3000);
                }
              }
            ).catch(err => {
              console.warn('[useChatBubbles] æ’­æ”¾è¯­éŸ³å¤±è´¥:', err);
              // å¤±è´¥å3ç§’éšè—
              setTimeout(() => {
                setSpeakingStates(prev => {
                  const newMap = new Map(prev);
                  newMap.set(translatedMessage.playerId, false);
                  return newMap;
                });
              }, 3000);
            });
          } else {
            // æ²¡æœ‰è¯­éŸ³é…ç½®ï¼Œ3ç§’åè‡ªåŠ¨éšè—
            setTimeout(() => {
              setSpeakingStates(prev => {
                const newMap = new Map(prev);
                newMap.set(translatedMessage.playerId, false);
                return newMap;
              });
            }, 3000);
          }
        });
    }
  }, [gameState.players, gameState.currentPlayerIndex]);

  // ç§»é™¤èŠå¤©æ°”æ³¡
  const removeChatBubble = useCallback((playerId: number) => {
    setActiveChatBubbles(prev => {
      const newMap = new Map(prev);
      newMap.delete(playerId);
      return newMap;
    });
    setSpeakingStates(prev => {
      const newMap = new Map(prev);
      newMap.delete(playerId);
      return newMap;
    });
  }, []);

  return {
    activeChatBubbles,
    speakingStates,  // æ–°å¢ï¼šæ’­æ”¾çŠ¶æ€
    removeChatBubble,
    getPlayerBubblePosition
  };
}
```

#### 4. å¤šå£°é“æœåŠ¡æ‰©å±•ï¼ˆæ”¯æŒäº‹ä»¶å›è°ƒï¼‰

```typescript
// src/services/multiChannelVoiceService.ts (æ‰©å±•)

async speak(
  text: string,
  voiceConfig?: VoiceConfig,
  channel: ChannelType = ChannelType.PLAYER_0,
  events?: {
    onStart?: () => void;
    onEnd?: () => void;
    onError?: (error: Error) => void;
    estimatedDuration?: number;
  }
): Promise<void> {
  return new Promise(async (resolve, reject) => {
    // ... ç°æœ‰ä»£ç  ...
    
    const utterance = this.createUtterance(text, voiceConfig, voices);
    
    // è®¾ç½®äº‹ä»¶å›è°ƒ
    utterance.onstart = () => {
      events?.onStart?.();
      console.log(`[${channelConfig.name}] å¼€å§‹æ’­æ”¾:`, text);
    };
    
    utterance.onend = () => {
      events?.onEnd?.();
      cleanup();
      resolve();
    };
    
    utterance.onerror = (error) => {
      events?.onError?.(error as Error);
      cleanup();
      reject(error as Error);
    };
    
    // æ’­æ”¾
    window.speechSynthesis.speak(utterance);
  });
}
```

#### 5. CSSå¢å¼ºï¼ˆæ’­æ”¾ä¸­åŠ¨ç”»ï¼‰

```css
/* src/components/ChatBubble.css (å¢å¼º) */

.chat-bubble.speaking {
  animation: pulse 1.5s ease-in-out infinite;
}

.chat-bubble.speaking .chat-bubble-content {
  box-shadow: 0 8px 32px rgba(102, 126, 234, 0.4);
}

.speaking-indicator {
  display: inline-block;
  margin-left: 8px;
  animation: bounce 0.6s ease-in-out infinite;
}

@keyframes pulse {
  0%, 100% {
    transform: scale(1);
  }
  50% {
    transform: scale(1.02);
  }
}

@keyframes bounce {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(-3px);
  }
}
```

### åŒæ­¥æµç¨‹

```
1. èŠå¤©æ¶ˆæ¯ç”Ÿæˆ
   â†“
2. æ˜¾ç¤ºæ°”æ³¡ï¼ˆåˆå§‹çŠ¶æ€ï¼šç­‰å¾…è¯­éŸ³ï¼‰
   â†“
3. å¼€å§‹æ’­æ”¾è¯­éŸ³
   â”œâ”€> onStart äº‹ä»¶è§¦å‘
   â”œâ”€> æ°”æ³¡å®Œå…¨æ˜¾ç¤ºï¼ˆspeaking=trueï¼‰
   â””â”€> æ˜¾ç¤ºæ’­æ”¾æŒ‡ç¤ºå™¨ ğŸ”Š
   â†“
4. è¯­éŸ³æ’­æ”¾ä¸­
   â”œâ”€> æ°”æ³¡ä¿æŒæ˜¾ç¤º
   â””â”€> æ’­æ”¾åŠ¨ç”»æ•ˆæœ
   â†“
5. è¯­éŸ³æ’­æ”¾å®Œæˆ
   â”œâ”€> onEnd äº‹ä»¶è§¦å‘
   â”œâ”€> speaking=false
   â”œâ”€> å¼€å§‹æ·¡å‡ºåŠ¨ç”»ï¼ˆ1ç§’ï¼‰
   â””â”€> æ·¡å‡ºå®Œæˆåéšè—æ°”æ³¡
```

### é”™è¯¯å¤„ç†

1. **è¯­éŸ³æ’­æ”¾å¤±è´¥**ï¼š3ç§’åè‡ªåŠ¨éšè—æ°”æ³¡
2. **è¯­éŸ³è¶…æ—¶**ï¼š10ç§’ä¿æŠ¤æœºåˆ¶ï¼Œè‡ªåŠ¨éšè—
3. **æ— è¯­éŸ³é…ç½®**ï¼š3ç§’åè‡ªåŠ¨éšè—

---

## ğŸ”„ å®Œæ•´æ•°æ®æµ

### åœºæ™¯ï¼šç©å®¶0å‡ºå¥½ç‰Œï¼Œè§¦å‘èŠå¤©

```
1. æ¸¸æˆäº‹ä»¶è§¦å‘
   â””â”€> ç©å®¶0å‡ºå¥½ç‰Œ â†’ triggerEventChat(ç©å®¶0, GOOD_PLAY)

2. LLMèŠå¤©å¤„ç†
   â”œâ”€> æç¤ºè¯é¢„å¤„ç†
   â”‚   â”œâ”€> DialectProcessor: æ·»åŠ å—æ˜Œè¯æŒ‡ä»¤
   â”‚   â”œâ”€> ContextProcessor: æ·»åŠ æ¸¸æˆçŠ¶æ€
   â”‚   â””â”€> TemplateProcessor: æ¸²æŸ“æç¤ºè¯
   â”‚
   â”œâ”€> LLMè°ƒç”¨
   â”‚   â”œâ”€> é€‰æ‹©æä¾›è€…ï¼ˆOllamaï¼‰
   â”‚   â”œâ”€> å‘é€è¯·æ±‚
   â”‚   â””â”€> æ¥æ”¶åŸå§‹è¿”å›ï¼š"å¥½çš„ï¼Œæˆ‘è§‰å¾—è¿™æ‰‹ç‰Œä¸é”™"
   â”‚
   â”œâ”€> è¿”å›ä¿¡æ¯åå¤„ç†
   â”‚   â”œâ”€> ContentCleaner: ç§»é™¤"å¥½çš„ï¼Œæˆ‘è§‰å¾—"
   â”‚   â”œâ”€> LengthController: é™åˆ¶15å­—
   â”‚   â”œâ”€> DialectAdapter: "è¿™æ‰‹ç‰Œä¸é”™" â†’ "æ°å™¶ï¼"
   â”‚   â””â”€> Translation: å¦‚æœUIæ˜¯è‹±æ–‡ â†’ "Good hand!"
   â”‚
   â””â”€> è®­ç»ƒæ•°æ®æ”¶é›†
       â””â”€> ä¿å­˜å®Œæ•´å¤„ç†æµç¨‹æ•°æ®

3. èŠå¤©æ¶ˆæ¯è¾“å‡º
   â””â”€> ChatMessage {
         playerId: 0,
         content: "æ°å™¶ï¼",  // æˆ– "Good hand!"
         type: 'event'
       }

4. UIæ˜¾ç¤º
   â”œâ”€> æ˜¾ç¤ºèŠå¤©æ°”æ³¡ï¼ˆç©å®¶0ä½ç½®ï¼‰
   â””â”€> è§¦å‘è¯­éŸ³æ’­æ”¾

5. å¤šå£°é“æ’­æ”¾
   â”œâ”€> è·å–ç©å®¶0çš„é¢‘é“ï¼ˆChannelType.PLAYER_0ï¼‰
   â”œâ”€> æ£€æŸ¥é¢‘é“çŠ¶æ€ï¼ˆç©ºé—²ï¼‰
   â”œâ”€> ä½¿ç”¨è¯­éŸ³å‚æ•°ï¼ˆrate: 1.0, pitch: 1.0ï¼‰
   â”œâ”€> è°ƒç”¨ speechSynthesis æ’­æ”¾
   â””â”€> æ’­æ”¾å®Œæˆï¼Œé‡Šæ”¾é¢‘é“
```

---

## ğŸ“¦ æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ chatProcessingService.ts      # ä¸»å¤„ç†æœåŠ¡ï¼ˆæ•´åˆæ‰€æœ‰ç»„ä»¶ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ prompt/
â”‚   â”‚   â”œâ”€â”€ promptPreprocessingPipeline.ts  # æç¤ºè¯é¢„å¤„ç†ç®¡é“
â”‚   â”‚   â”œâ”€â”€ processors/
â”‚   â”‚   â”‚   â”œâ”€â”€ dialectPromptProcessor.ts  # æ–¹è¨€å¤„ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ contextEnhancerProcessor.ts # ä¸Šä¸‹æ–‡å¢å¼º
â”‚   â”‚   â”‚   â”œâ”€â”€ historyProcessor.ts         # å†å²è®°å½•
â”‚   â”‚   â”‚   â””â”€â”€ templateRendererProcessor.ts # æ¨¡æ¿æ¸²æŸ“
â”‚   â”‚   â””â”€â”€ promptBuilder.ts               # åŸºç¡€æç¤ºè¯æ„å»º
â”‚   â”‚
â”‚   â”œâ”€â”€ llm/
â”‚   â”‚   â”œâ”€â”€ llmProviderManager.ts          # LLMæä¾›è€…ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ providers/
â”‚   â”‚   â”‚   â”œâ”€â”€ ILLMProvider.ts            # æ¥å£å®šä¹‰
â”‚   â”‚   â”‚   â”œâ”€â”€ ollamaProvider.ts          # Ollamaæä¾›è€…
â”‚   â”‚   â”‚   â”œâ”€â”€ openAIProvider.ts          # OpenAIæä¾›è€…ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â”‚   â””â”€â”€ customProvider.ts          # è‡ªå®šä¹‰æä¾›è€…ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚   â””â”€â”€ llmConfig.ts                   # LLMé…ç½®
â”‚   â”‚
â”‚   â”œâ”€â”€ response/
â”‚   â”‚   â”œâ”€â”€ responsePostprocessingPipeline.ts # è¿”å›ä¿¡æ¯åå¤„ç†ç®¡é“
â”‚   â”‚   â”œâ”€â”€ processors/
â”‚   â”‚   â”‚   â”œâ”€â”€ contentCleanerProcessor.ts    # å†…å®¹æ¸…ç†
â”‚   â”‚   â”‚   â”œâ”€â”€ lengthControllerProcessor.ts # é•¿åº¦æ§åˆ¶
â”‚   â”‚   â”‚   â”œâ”€â”€ formatNormalizerProcessor.ts  # æ ¼å¼æ ‡å‡†åŒ–
â”‚   â”‚   â”‚   â”œâ”€â”€ dialectAdapterProcessor.ts    # æ–¹è¨€é€‚é…
â”‚   â”‚   â”‚   â””â”€â”€ translationProcessor.ts      # ç¿»è¯‘å¤„ç†
â”‚   â”‚   â””â”€â”€ contentProcessor.ts              # ç°æœ‰å†…å®¹å¤„ç†ï¼ˆä¿ç•™ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ training/
â”‚   â”‚   â”œâ”€â”€ trainingDataCollector.ts         # è®­ç»ƒæ•°æ®æ”¶é›†å™¨ï¼ˆæ‰©å±•ï¼‰
â”‚   â”‚   â”œâ”€â”€ trainingDataExporter.ts         # æ•°æ®å¯¼å‡ºå·¥å…·
â”‚   â”‚   â””â”€â”€ qualityAssessor.ts              # è´¨é‡è¯„ä¼°ï¼ˆå¯é€‰ï¼‰
â”‚   â”‚
â”‚   â”œâ”€â”€ voice/
â”‚   â”‚   â”œâ”€â”€ channelManager.ts               # é¢‘é“ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ multiChannelVoiceService.ts     # å¤šå£°é“è¯­éŸ³æœåŠ¡ï¼ˆç°æœ‰ï¼Œå¢å¼ºï¼‰
â”‚   â”‚   â”œâ”€â”€ voiceService.ts                 # è¯­éŸ³æœåŠ¡åŒ…è£…ï¼ˆç°æœ‰ï¼‰
â”‚   â”‚   â””â”€â”€ voiceQueueManager.ts            # è¯­éŸ³é˜Ÿåˆ—ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ translationService.ts               # ç¿»è¯‘æœåŠ¡ï¼ˆç°æœ‰ï¼Œå¢å¼ºï¼‰
â”‚
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useChatBubbles.ts                   # èŠå¤©æ°”æ³¡Hookï¼ˆç°æœ‰ï¼Œå¢å¼ºï¼‰
â”‚   â””â”€â”€ useChatProcessing.ts                # èŠå¤©å¤„ç†Hookï¼ˆæ–°å»ºï¼‰
â”‚
â””â”€â”€ config/
    â”œâ”€â”€ chatConfig.ts                       # èŠå¤©é…ç½®ï¼ˆç°æœ‰ï¼Œæ‰©å±•ï¼‰
    â”œâ”€â”€ voiceConfig.ts                      # è¯­éŸ³é…ç½®ï¼ˆç°æœ‰ï¼‰
    â””â”€â”€ trainingConfig.ts                   # è®­ç»ƒé…ç½®ï¼ˆæ–°å»ºï¼‰
```

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. æˆæœ¬ä¼˜åŠ¿
- âœ… **å®Œå…¨å…è´¹**ï¼šä½¿ç”¨æµè§ˆå™¨å†…ç½®API
- âœ… **æ— éœ€TTS API**ï¼šèŠ‚çœå¤§é‡è´¹ç”¨
- âœ… **æœ¬åœ°LLM**ï¼šOllamaæœ¬åœ°è¿è¡Œï¼Œæ— APIè´¹ç”¨

### 2. åŠŸèƒ½ä¼˜åŠ¿
- âœ… **çœŸæ­£çš„å¤šå£°é“**ï¼šæ¯ä¸ªç©å®¶ç‹¬ç«‹é¢‘é“
- âœ… **æ–¹è¨€æ”¯æŒ**ï¼šLLMç”Ÿæˆæ–¹è¨€æ–‡æœ¬
- âœ… **å¤šè¯­è¨€æ”¯æŒ**ï¼šè‡ªåŠ¨ç¿»è¯‘
- âœ… **è®­ç»ƒæ•°æ®å®Œæ•´**ï¼šè®°å½•å…¨æµç¨‹æ•°æ®

### 3. æŠ€æœ¯ä¼˜åŠ¿
- âœ… **å¯æ‰©å±•æ¶æ„**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
- âœ… **å¯ç»´æŠ¤æ€§**ï¼šèŒè´£åˆ†ç¦»ï¼Œæ˜“äºæµ‹è¯•
- âœ… **é«˜æ€§èƒ½**ï¼šæœ¬åœ°å¤„ç†ï¼Œå»¶è¿Ÿä½
- âœ… **å¯æ’æ‹”**ï¼šå¤„ç†å™¨å¯åŠ¨æ€å¯ç”¨/ç¦ç”¨

---

## ğŸš€ å®ç°ä¼˜å…ˆçº§

### Phase 1: æ ¸å¿ƒæ¶æ„ï¼ˆ1-2å‘¨ï¼‰
1. å®ç°æç¤ºè¯é¢„å¤„ç†ç®¡é“
2. å®ç°LLMæä¾›è€…ç®¡ç†å™¨
3. å®ç°è¿”å›ä¿¡æ¯åå¤„ç†ç®¡é“
4. æ‰©å±•è®­ç»ƒæ•°æ®æ”¶é›†å™¨
5. åˆ›å»ºç»Ÿä¸€èŠå¤©å¤„ç†æœåŠ¡

### Phase 2: å¤šå£°é“ç³»ç»Ÿï¼ˆ1å‘¨ï¼‰
1. å®ç°é¢‘é“ç®¡ç†å™¨
2. å¢å¼ºå¤šå£°é“è¯­éŸ³æœåŠ¡
3. å®ç°è¯­éŸ³é˜Ÿåˆ—ç®¡ç†
4. é›†æˆç¿»è¯‘æœåŠ¡

### Phase 3: é›†æˆå’Œä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰
1. é›†æˆæ‰€æœ‰ç»„ä»¶
2. ä¼˜åŒ–æ€§èƒ½
3. æ·»åŠ é”™è¯¯å¤„ç†
4. ç¼–å†™æµ‹è¯•

### Phase 4: é«˜çº§åŠŸèƒ½ï¼ˆå¯é€‰ï¼‰
1. è´¨é‡è¯„ä¼°ç³»ç»Ÿ
2. A/Bæµ‹è¯•æ”¯æŒ
3. å®æ—¶ç›‘æ§
4. æ•°æ®åˆ†æå·¥å…·

---

## ğŸ“Š æ•°æ®æµç¤ºä¾‹

### å®Œæ•´ç¤ºä¾‹ï¼šç©å®¶0ï¼ˆå—æ˜Œè¯ï¼‰å‡ºå¥½ç‰Œ

```typescript
// 1. æ¸¸æˆäº‹ä»¶
triggerEventChat(player0, ChatEventType.GOOD_PLAY)

// 2. æç¤ºè¯é¢„å¤„ç†
åŸå§‹æç¤ºè¯: "ä½ æ˜¯ä¸€ä¸ªè¿‡ç‚¸ç‰Œæ¸¸æˆçš„AIç©å®¶..."
â†“
DialectProcessor: æ·»åŠ å—æ˜Œè¯æŒ‡ä»¤
â†“
ContextProcessor: æ·»åŠ æ¸¸æˆçŠ¶æ€
â†“
æœ€ç»ˆæç¤ºè¯: "ä½ æ˜¯ä¸€ä¸ªè¿‡ç‚¸ç‰Œæ¸¸æˆçš„AIç©å®¶...\næ–¹è¨€è¦æ±‚ï¼ˆå—æ˜Œè¯ï¼‰...\næ¸¸æˆçŠ¶æ€..."

// 3. LLMè°ƒç”¨
OllamaProvider.call({
  prompt: "æœ€ç»ˆæç¤ºè¯",
  model: "qwen2:0.5b"
})
â†“
åŸå§‹è¿”å›: "å¥½çš„ï¼Œæˆ‘è§‰å¾—è¿™æ‰‹ç‰Œä¸é”™ï¼Œåº”è¯¥å¯ä»¥å‡ºã€‚"

// 4. è¿”å›ä¿¡æ¯åå¤„ç†
ContentCleaner: "è¿™æ‰‹ç‰Œä¸é”™ï¼Œåº”è¯¥å¯ä»¥å‡ºã€‚"
â†“
LengthController: "è¿™æ‰‹ç‰Œä¸é”™" (15å­—)
â†“
DialectAdapter: "æ°å™¶ï¼" (å—æ˜Œè¯)
â†“
Translation: "æ°å™¶ï¼" (UIæ˜¯ä¸­æ–‡ï¼Œä¸ç¿»è¯‘)

// 5. è®­ç»ƒæ•°æ®æ”¶é›†
collectFullSample({
  originalPrompt: "...",
  processedPrompt: "...",
  rawContent: "å¥½çš„ï¼Œæˆ‘è§‰å¾—è¿™æ‰‹ç‰Œä¸é”™...",
  processedContent: "æ°å™¶ï¼",
  processingStats: {...},
  context: {...}
})

// 6. è¾“å‡ºèŠå¤©æ¶ˆæ¯
ChatMessage {
  playerId: 0,
  content: "æ°å™¶ï¼",
  type: 'event'
}

// 7. UIæ˜¾ç¤º
æ˜¾ç¤ºèŠå¤©æ°”æ³¡ï¼ˆç©å®¶0ä½ç½®ï¼Œæ˜¾ç¤º"æ°å™¶ï¼"ï¼‰

// 8. è¯­éŸ³æ’­æ”¾
ChannelManager.getChannel(0) â†’ ChannelType.PLAYER_0
â†“
VoiceService.speak("æ°å™¶ï¼", voiceConfig0, ChannelType.PLAYER_0)
â†“
speechSynthesis.speak(utterance) // ä½¿ç”¨æ™®é€šè¯TTSæ’­æ”¾å—æ˜Œè¯æ–‡æœ¬
```

---

## ğŸ”§ é…ç½®ç¤ºä¾‹

### èŠå¤©å¤„ç†é…ç½®
```typescript
{
  // æç¤ºè¯é¢„å¤„ç†
  promptProcessors: [
    'dialect',
    'context-enhancer',
    'history',
    'template-renderer'
  ],
  
  // LLMé…ç½®
  llm: {
    provider: 'ollama',
    model: 'qwen2:0.5b',
    temperature: 0.8,
    maxTokens: 50,
    timeout: 60000
  },
  
  // è¿”å›ä¿¡æ¯åå¤„ç†
  responseProcessors: [
    'content-cleaner',
    'length-controller',
    'format-normalizer',
    'dialect-adapter',
    'translation'
  ],
  
  // è®­ç»ƒæ•°æ®æ”¶é›†
  training: {
    enabled: true,
    maxSamples: 10000,
    autoExport: false,
    exportFormat: 'jsonl'
  }
}
```

### å¤šå£°é“é…ç½®
```typescript
{
  // é¢‘é“é…ç½®
  channels: {
    maxConcurrent: 2,  // æœ€å¤šåŒæ—¶æ’­æ”¾2ä¸ªé¢‘é“
    queueStrategy: 'priority',  // ä¼˜å…ˆçº§é˜Ÿåˆ—
    timeOffset: 150  // æ—¶é—´é”™å¼€ï¼ˆæ¯«ç§’ï¼‰
  },
  
  // è¯­éŸ³å‚æ•°
  voiceParams: {
    player0: { rate: 1.0, pitch: 1.0, volume: 0.9 },
    player1: { rate: 1.1, pitch: 1.1, volume: 0.95 },
    player2: { rate: 0.95, pitch: 0.9, volume: 0.85 },
    player3: { rate: 1.05, pitch: 1.05, volume: 0.9 }
  }
}
```

---

## âœ… æ€»ç»“

è¿™ä¸ªæ¶æ„æ•´åˆäº†ï¼š
1. âœ… **LLMèŠå¤©å¤„ç†**ï¼šå®Œæ•´çš„é¢„å¤„ç†ã€è°ƒç”¨ã€åå¤„ç†æµç¨‹
2. âœ… **è®­ç»ƒæ•°æ®æ”¶é›†**ï¼šè®°å½•å…¨æµç¨‹æ•°æ®ï¼Œæ”¯æŒæœªæ¥è®­ç»ƒ
3. âœ… **å¤šå£°é“ç³»ç»Ÿ**ï¼šæ¯ä¸ªç©å®¶ç‹¬ç«‹é¢‘é“ï¼Œå…è´¹å®ç°
4. âœ… **æ–¹è¨€æ”¯æŒ**ï¼šLLMç”Ÿæˆæ–¹è¨€æ–‡æœ¬ï¼Œæ™®é€šè¯TTSæ’­æ”¾
5. âœ… **å¤šè¯­è¨€æ”¯æŒ**ï¼šè‡ªåŠ¨ç¿»è¯‘ï¼Œå›½é™…åŒ–
6. âœ… **å¯æ‰©å±•æ€§**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½

**æˆæœ¬ï¼š0å…ƒ**ï¼ˆå®Œå…¨å…è´¹ï¼‰
**åŠŸèƒ½ï¼šå®Œæ•´**ï¼ˆæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼‰
**å¯ç»´æŠ¤æ€§ï¼šé«˜**ï¼ˆæ¶æ„æ¸…æ™°ï¼Œæ˜“äºæ‰©å±•ï¼‰

