# 多语言框架技术决策文档

## 📋 概述

本文档记录多语言框架重构过程中的关键技术决策，包括方案选择、理由和权衡。

## 🎯 决策原则

1. **可维护性优先**: 代码清晰，易于理解和修改
2. **开发体验优先**: 提供良好的开发工具和类型支持
3. **性能考虑**: 不影响应用性能
4. **向后兼容**: 平滑迁移，不破坏现有功能

## 🔧 关键技术决策

### 决策1: 命名空间策略

#### 问题
如何组织翻译键的命名空间？

#### 选项

**选项A: 组件级命名空间（推荐）**
```
component:GameConfigPanel:title
component:GameConfigPanel:buttons.start
```

**选项B: 功能级命名空间**
```
feature:game:config.title
feature:game:config.buttons.start
```

**选项C: 扁平命名空间**
```
gameConfig.title
gameConfig.buttons.start
```

#### 决策: 选项A - 组件级命名空间

#### 理由
1. **模块化**: 每个组件独立管理翻译，职责清晰
2. **可维护性**: 组件删除时，翻译文件一起删除
3. **可扩展性**: 新增组件时自动创建命名空间
4. **类型安全**: 组件级类型定义更精确

#### 权衡
- ✅ 优点: 模块化、易维护、类型安全
- ⚠️ 缺点: 命名空间较长，需要工具支持

---

### 决策2: 翻译文件组织方式

#### 问题
翻译文件如何组织？按组件还是按语言？

#### 选项

**选项A: 按组件组织（推荐）**
```
i18n-resources/
├── components/
│   ├── GameConfigPanel/
│   │   ├── zh-CN.json
│   │   ├── en-US.json
│   │   └── ...
│   └── ...
```

**选项B: 按语言组织**
```
i18n-resources/
├── zh-CN/
│   ├── GameConfigPanel.json
│   └── ...
├── en-US/
│   ├── GameConfigPanel.json
│   └── ...
```

#### 决策: 选项A - 按组件组织

#### 理由
1. **组件完整性**: 一个组件的所有语言翻译在一起
2. **易于管理**: 新增组件时只需创建一个目录
3. **版本控制**: Git 变更更清晰，按组件查看
4. **工具友好**: 扫描和生成工具更容易实现

#### 权衡
- ✅ 优点: 组件完整、易于管理、工具友好
- ⚠️ 缺点: 跨语言查找需要遍历多个文件

---

### 决策3: 类型生成策略

#### 问题
类型定义何时生成？编译时还是运行时？

#### 选项

**选项A: 编译时生成（推荐）**
- 构建时生成类型文件
- 类型定义静态存在
- IDE 完整支持

**选项B: 运行时生成**
- 运行时动态生成类型
- 类型定义动态存在
- IDE 支持有限

#### 决策: 选项A - 编译时生成

#### 理由
1. **类型安全**: 编译时检查，提前发现错误
2. **IDE 支持**: 完整的自动补全和类型提示
3. **性能**: 无运行时开销
4. **开发体验**: 更好的开发体验

#### 权衡
- ✅ 优点: 类型安全、IDE 支持、性能好
- ⚠️ 缺点: 需要构建步骤，类型更新需要重新生成

---

### 决策4: 资源加载策略

#### 问题
翻译资源何时加载？立即加载还是按需加载？

#### 选项

**选项A: 懒加载（推荐）**
- 组件使用时加载
- 减少初始加载时间
- 按需加载资源

**选项B: 预加载**
- 应用启动时加载所有
- 初始加载时间长
- 运行时无延迟

**选项C: 混合策略**
- 关键翻译预加载
- 其他翻译懒加载

#### 决策: 选项C - 混合策略

#### 理由
1. **性能平衡**: 关键翻译快速显示，其他按需加载
2. **用户体验**: 首屏快速，后续流畅
3. **灵活性**: 可配置哪些翻译预加载

#### 实现
```typescript
// 配置预加载的命名空间
const preloadNamespaces = [
  'shared:common',
  'shared:ui',
  'feature:game',
];

// 其他命名空间懒加载
```

#### 权衡
- ✅ 优点: 性能平衡、用户体验好
- ⚠️ 缺点: 实现稍复杂，需要配置

---

### 决策5: 翻译键命名规范

#### 问题
翻译键如何命名？使用什么规范？

#### 选项

**选项A: 驼峰命名（推荐）**
```
title
playerCount
startGame
```

**选项B: 点分隔命名**
```
title
player.count
game.start
```

**选项C: 下划线命名**
```
title
player_count
start_game
```

#### 决策: 选项A - 驼峰命名

#### 理由
1. **JavaScript 风格**: 符合 JS/TS 命名习惯
2. **简洁性**: 键名更短
3. **类型友好**: TypeScript 属性名通常驼峰
4. **一致性**: 与代码命名一致

#### 规范
```typescript
// 好的命名
title
playerCount
startGame
confirmButton

// 避免的命名
Title
player_count
start-game
confirm_button
```

#### 权衡
- ✅ 优点: 简洁、一致、类型友好
- ⚠️ 缺点: 层级关系不够明显（可通过结构体现）

---

### 决策6: 工具集成方式

#### 问题
工具如何集成到开发流程？

#### 选项

**选项A: NPM Scripts（推荐）**
```json
{
  "scripts": {
    "i18n:scan": "ts-node scripts/i18n/scan.ts",
    "i18n:generate": "ts-node scripts/i18n/generate.ts"
  }
}
```

**选项B: Vite Plugin**
```typescript
// vite.config.ts
import i18nPlugin from './vite-plugins/i18nPlugin';

export default {
  plugins: [i18nPlugin()]
};
```

**选项C: 独立 CLI 工具**
```bash
npx i18n-tool scan
```

#### 决策: 选项A + 选项B - NPM Scripts + Vite Plugin

#### 理由
1. **灵活性**: NPM Scripts 用于手动操作
2. **自动化**: Vite Plugin 用于开发时自动检查
3. **易用性**: 开发者熟悉 NPM Scripts
4. **可扩展**: 未来可升级为独立 CLI

#### 实现
- **开发时**: Vite Plugin 自动扫描和验证
- **构建时**: NPM Scripts 生成类型和验证
- **手动操作**: NPM Scripts 提供完整工具

#### 权衡
- ✅ 优点: 灵活、自动化、易用
- ⚠️ 缺点: 需要维护两套工具

---

### 决策7: 向后兼容策略

#### 问题
如何保证现有代码继续工作？

#### 选项

**选项A: 完全兼容（推荐）**
- 保留旧的 API
- 提供适配层
- 逐步迁移

**选项B: 强制迁移**
- 移除旧 API
- 一次性迁移
- 可能破坏现有功能

#### 决策: 选项A - 完全兼容

#### 理由
1. **平滑迁移**: 不中断开发
2. **降低风险**: 逐步迁移，降低出错概率
3. **灵活性**: 新旧系统可共存

#### 实现
```typescript
// 适配层
export function useTranslation(namespaces: string[]) {
  // 兼容旧的 useTranslation
  // 内部使用新的系统
  return useComponentTranslation(/* ... */);
}
```

#### 迁移计划
1. **阶段1**: 新系统上线，旧系统保留
2. **阶段2**: 逐步迁移组件
3. **阶段3**: 移除旧系统（可选）

#### 权衡
- ✅ 优点: 平滑迁移、降低风险
- ⚠️ 缺点: 代码复杂度增加，需要维护两套系统

---

### 决策8: 翻译文件格式

#### 问题
使用什么格式存储翻译？JSON、YAML 还是其他？

#### 选项

**选项A: JSON（推荐）**
- 标准格式
- 工具支持好
- 易于解析

**选项B: YAML**
- 可读性好
- 支持注释
- 需要额外依赖

**选项C: TypeScript**
- 类型安全
- 可直接导入
- 需要编译

#### 决策: 选项A - JSON

#### 理由
1. **标准格式**: 无需额外依赖
2. **工具支持**: 所有工具都支持 JSON
3. **性能**: 解析速度快
4. **兼容性**: 与现有系统兼容

#### 权衡
- ✅ 优点: 标准、工具支持好、性能好
- ⚠️ 缺点: 不支持注释（可通过工具添加元数据）

---

### 决策9: 错误处理策略

#### 问题
翻译缺失或错误时如何处理？

#### 选项

**选项A: 优雅降级（推荐）**
- 显示翻译键
- 记录警告
- 回退到默认语言

**选项B: 抛出错误**
- 开发时抛出错误
- 生产时显示占位符

#### 决策: 选项A - 优雅降级

#### 理由
1. **用户体验**: 应用不崩溃
2. **开发体验**: 开发时提供警告
3. **可调试**: 显示翻译键便于定位

#### 实现
```typescript
function translate(key: string): string {
  const translation = findTranslation(key);
  
  if (!translation) {
    if (isDevMode) {
      console.warn(`Missing translation: ${key}`);
    }
    return `[${key}]`; // 开发时显示键，生产时显示占位符
  }
  
  return translation;
}
```

#### 权衡
- ✅ 优点: 用户体验好、可调试
- ⚠️ 缺点: 可能隐藏问题（通过工具检查解决）

---

### 决策10: 性能优化策略

#### 问题
如何优化翻译系统的性能？

#### 策略

1. **懒加载**: 按需加载翻译资源
2. **缓存**: 已加载资源缓存
3. **预加载**: 关键翻译预加载
4. **代码分割**: 按语言代码分割

#### 实现
```typescript
// 懒加载
const loadTranslation = async (namespace: string) => {
  if (cache.has(namespace)) {
    return cache.get(namespace);
  }
  
  const resource = await import(`./locales/${namespace}.json`);
  cache.set(namespace, resource);
  return resource;
};

// 预加载关键翻译
const preloadCritical = async () => {
  await Promise.all([
    loadTranslation('shared:common'),
    loadTranslation('shared:ui'),
  ]);
};
```

#### 权衡
- ✅ 优点: 性能优化明显
- ⚠️ 缺点: 实现复杂度增加

---

## 📊 决策总结

| 决策项 | 选择 | 优先级 | 影响范围 |
|--------|------|--------|----------|
| 命名空间策略 | 组件级 | 高 | 整体架构 |
| 文件组织 | 按组件 | 高 | 文件结构 |
| 类型生成 | 编译时 | 高 | 开发体验 |
| 加载策略 | 混合 | 中 | 性能 |
| 键命名 | 驼峰 | 中 | 开发体验 |
| 工具集成 | NPM + Plugin | 中 | 开发流程 |
| 向后兼容 | 完全兼容 | 高 | 迁移风险 |
| 文件格式 | JSON | 低 | 实现细节 |
| 错误处理 | 优雅降级 | 中 | 用户体验 |
| 性能优化 | 多策略 | 中 | 性能 |

## 🔄 决策变更记录

### 版本 1.0 (当前)
- 所有决策已确定
- 等待实施验证

### 未来可能的变更
- 根据实施反馈调整
- 根据使用情况优化
- 根据新技术更新

## 📝 待讨论问题

1. **命名空间层级**: 是否需要支持更深层级？
2. **翻译版本控制**: 是否需要版本管理？
3. **协作翻译**: 是否需要多人协作功能？
4. **自动翻译**: 是否集成自动翻译 API？

## 🎯 下一步行动

1. 评审所有技术决策
2. 确认决策合理性
3. 开始实施
4. 根据实施反馈调整

