# 聊天和语音系统优化重构计划

## 📋 需求分析

### 当前需求
1. ✅ **流畅聊天** - 减少延迟，提高响应速度
2. ❓ **多声道支持** - 需要确认是否支持多人同时聊天
3. ✅ **模拟地方方言** - 已实现南昌话映射
4. ✅ **聊天文字和语音同步** - 已实现，但需要优化

### 技术现状分析

#### 当前实现
- 使用 `window.speechSynthesis` API（浏览器原生TTS）
- 实现"伪并发"机制：通过时间错开（50ms）模拟同时播放
- `maxConcurrentSpeakers = 4`，但实际上 `speechSynthesis` 只能串行播放

#### 技术限制
⚠️ **关键发现**：`window.speechSynthesis` 是**单声道API**，无法真正同时播放多个语音。

**验证方法**：
```javascript
// 测试代码
const u1 = new SpeechSynthesisUtterance("第一句话");
const u2 = new SpeechSynthesisUtterance("第二句话");
window.speechSynthesis.speak(u1);
window.speechSynthesis.speak(u2);
// 结果：u2会等待u1完成后才播放，无法真正同时播放
```

## 🎯 优化方案

### 方案A：保持串行播放（推荐，简单高效）

**策略**：既然无法真正同时播放，改为**一次只播放一个聊天语音**，确保流畅和清晰。

#### 优点
- ✅ 实现简单，无需额外依赖
- ✅ 语音清晰，不会重叠混乱
- ✅ 性能好，无网络延迟
- ✅ 用户体验好（不会听不清）

#### 实现要点
1. **串行队列管理**
   - 所有聊天语音加入统一队列
   - 按优先级排序（对骂 > 事件 > 随机）
   - 报牌可以中断聊天（优先级最高）

2. **快速响应**
   - 减少队列等待时间
   - 优化LLM响应时间
   - 缓存常用回复

3. **智能去重**
   - 相同内容不重复播放
   - 短时间内相同消息合并

### 方案B：实现真正多声道（复杂，需要TTS API）

**策略**：使用在线TTS API + Web Audio API实现真正的多声道。

#### 优点
- ✅ 真正的多声道，可以同时播放
- ✅ 音质更好
- ✅ 可以缓存音频

#### 缺点
- ❌ 需要API密钥（费用）
- ❌ 需要网络连接
- ❌ 有延迟（API调用 + 下载）
- ❌ 实现复杂

#### 技术方案
1. **TTS API选择**
   - Google Cloud TTS（质量好，费用高）
   - Azure TTS（质量好，费用中等）
   - 百度TTS（国内，费用低）
   - 科大讯飞TTS（国内，支持方言）

2. **实现步骤**
   - 调用TTS API生成音频
   - 下载音频文件
   - 使用Web Audio API播放到不同声道
   - 实现音频缓存机制

## 📝 详细优化计划

### 阶段1：串行播放优化（推荐先做）

#### 1.1 统一队列管理
- [ ] 移除"伪并发"机制
- [ ] 实现单一聊天队列
- [ ] 按优先级排序（对骂 > 事件 > 随机）
- [ ] 报牌可以中断聊天

**预期效果**：
- 语音清晰，不重叠
- 响应速度快
- 用户体验好

#### 1.2 队列优化
- [ ] 减少队列长度（当前20，可降到10）
- [ ] 实现智能丢弃（丢弃最旧的低优先级消息）
- [ ] 优化队列处理逻辑

#### 1.3 响应速度优化
- [ ] LLM请求优化
   - 减少超时时间（当前20秒，可降到10秒）
   - 增加缓存命中率
   - 优化prompt长度
- [ ] 语音播放优化
   - 减少延迟
   - 优化去重逻辑

### 阶段2：方言系统优化

#### 2.1 方言映射扩展
- [ ] 继续扩展南昌话映射表（当前约50个，目标500+）
- [ ] 使用LLM训练生成更多映射
- [ ] 手动审核和优化映射质量

#### 2.2 方言支持扩展
- [ ] 支持更多方言（粤语、上海话、四川话等）
- [ ] 实现方言映射训练系统
- [ ] 支持方言语音包（未来）

#### 2.3 方言文本生成优化
- [ ] 优化LLM prompt，生成更地道的方言文本
- [ ] 实现方言文本后处理
- [ ] 支持方言脏话映射

### 阶段3：文字和语音同步优化

#### 3.1 同步机制优化
- [ ] 确保气泡在语音真正开始时显示
- [ ] 优化 `onStart` 事件触发时机
- [ ] 处理队列中消息的同步

#### 3.2 气泡显示优化
- [ ] 优化气泡动画
- [ ] 优化气泡位置（不遮挡UI）
- [ ] 优化气泡消失时机

#### 3.3 错误处理
- [ ] 处理语音播放失败的情况
- [ ] 处理超时情况
- [ ] 处理网络错误

### 阶段4：流畅度优化

#### 4.1 LLM请求优化
- [ ] 实现请求去重
- [ ] 实现请求合并
- [ ] 优化请求队列

#### 4.2 缓存优化
- [ ] 增加缓存命中率
- [ ] 优化缓存策略
- [ ] 实现智能缓存

#### 4.3 性能优化
- [ ] 减少不必要的计算
- [ ] 优化内存使用
- [ ] 优化渲染性能

## 🔄 方案选择建议

### 推荐：方案A（串行播放）

**理由**：
1. **技术可行性**：当前技术栈无法实现真正多声道
2. **用户体验**：串行播放更清晰，不会混乱
3. **实现成本**：低，只需优化现有代码
4. **维护成本**：低，无需额外依赖

### 如果未来需要多声道

**条件**：
- 有TTS API预算
- 需要真正的多声道效果
- 可以接受网络延迟

**实现路径**：
1. 先完成串行播放优化
2. 评估用户反馈
3. 如果确实需要，再实现TTS API方案

## 📊 成功指标

### 流畅度指标
- [ ] 聊天响应时间 < 2秒（从触发到显示气泡）
- [ ] 语音播放延迟 < 500ms（从显示气泡到开始播放）
- [ ] 队列等待时间 < 5秒

### 同步指标
- [ ] 气泡和语音同步误差 < 200ms
- [ ] 气泡显示时机准确率 > 95%

### 方言指标
- [ ] 南昌话映射表 > 500条
- [ ] 方言转换准确率 > 90%

## 🚀 实施优先级

### P0（立即实施）
1. ✅ **串行播放优化** - 已完成
   - ✅ 移除伪并发机制
   - ✅ 实现单一聊天队列，按优先级排序（对骂 > 事件 > 随机）
   - ✅ 报牌可以中断聊天（优先级最高）
   - ✅ 实现 `addToChatQueue` 和 `processNextChat` 方法
2. ✅ **队列管理优化** - 已完成
   - ✅ 实现智能丢弃（丢弃低优先级消息）
   - ✅ 减少队列长度（从20降到10）
3. ✅ **同步机制优化** - 已完成
   - ✅ 气泡在语音真正开始时显示
   - ✅ 队列中的消息也能正确同步
4. ✅ **单元测试和回归测试** - 已完成
   - ✅ 创建 `serialVoicePlayback.test.ts` 单元测试
   - ✅ 创建 `serialVoicePlaybackRegression.test.ts` 回归测试
   - ✅ 测试覆盖：优先级排序、串行播放、报牌中断、队列管理、气泡同步

### P1（近期实施）
1. 方言映射扩展
2. LLM请求优化
3. 缓存优化

### P2（未来考虑）
1. 多声道实现（如果需要）
2. 更多方言支持
3. 方言语音包

## 📅 时间估算

- **阶段1**：1-2周
- **阶段2**：2-3周
- **阶段3**：1周
- **阶段4**：1-2周

**总计**：5-8周

## 🎯 下一步行动

1. **确认方案**：选择方案A（串行播放）还是方案B（多声道）
2. **开始实施**：从阶段1开始
3. **持续优化**：根据用户反馈调整

---

**最后更新**：2025-01-25
**状态**：待确认方案

