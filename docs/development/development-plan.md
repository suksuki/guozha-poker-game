# 过炸牌游戏 - 开发设计计划

## 📋 目录

1. [项目概述](#项目概述)
2. [已完成功能总结](#已完成功能总结)
3. [当前架构](#当前架构)
4. [短期开发计划](#短期开发计划)
5. [中期开发计划](#中期开发计划)
6. [长期开发计划](#长期开发计划)
7. [多模态方言语音包训练方案](#多模态方言语音包训练方案)
8. [💡 讨论和想法](#讨论和想法)

---

## 项目概述

### 核心定位
- **游戏类型**：过炸牌游戏（多人对战）
- **核心特色**：AI聊天系统 + 多声道语音 + 方言支持
- **技术栈**：React + TypeScript + Electron + Ollama (本地LLM)

### 核心价值
1. **免费多声道语音系统**：使用浏览器API实现，无需付费TTS服务
2. **智能AI聊天**：基于本地LLM，支持方言文本生成
3. **训练数据收集**：完整记录LLM处理流程，支持未来模型微调
4. **可扩展架构**：模块化设计，易于添加新功能

---

## 已完成功能总结

### 1. 多声道语音系统 ✅

#### 实现方案
- **技术**：Web Audio API + `speechSynthesis` API
- **声道分配**：
  - 玩家0：左声道（pan = -0.8）
  - 玩家1：右声道（pan = 0.8）
  - 玩家2：左中（pan = -0.4）
  - 玩家3：右中（pan = 0.4）
  - 系统：中央（pan = 0.0）

#### 核心特性
- ✅ 每个玩家独立声道
- ✅ 并发播放控制（最多2个同时播放）
- ✅ 时间错开模拟（150ms延迟）
- ✅ 音量混合（并发时降低到75%）
- ✅ 队列管理（优先级排序）

#### 相关文档
- `MULTI_CHANNEL_VOICE.md` - 多声道语音实现指南
- `MULTI_CHANNEL_IMPLEMENTATION.md` - 实现方案详解
- `MULTI_CHANNEL_USAGE.md` - 使用指南
- `MULTI_PLAYER_CONCURRENT_SPEECH.md` - 多玩家并发语音实现

#### 技术限制
- ⚠️ 浏览器无法直接捕获 `speechSynthesis` 输出
- ⚠️ 使用声像定位模拟多声道（非真正的多声道）
- 💡 未来方案：使用TTS API生成音频文件，然后用Web Audio API播放

---

### 2. LLM聊天系统 ✅

#### 架构设计
```
游戏事件 → LLM聊天处理 → 训练数据收集 → 聊天消息 → UI显示 + 语音播放
```

#### 核心组件
1. **LLM聊天策略** (`LLMChatStrategy.ts`)
   - 随机闲聊生成
   - 事件聊天生成
   - 对骂内容生成

2. **请求队列管理**
   - 并发控制：最多2个同时请求
   - 优先级排序：对骂（3）> 事件（2）> 随机（1）
   - 请求去重和缓存（5秒）
   - 超时控制：20秒

3. **内容处理**
   - 内容清理（移除冗余）
   - 长度控制（最多15字）
   - 格式标准化
   - 方言适配

#### 相关文档
- `LLM_REQUEST_QUEUE_OPTIMIZATION.md` - LLM请求队列优化
- `CHAT_PERFORMANCE_OPTIMIZATION.md` - 聊天性能优化
- `CHAT_QUEUE_OPTIMIZATION.md` - 聊天队列优化
- `LLM_TRAINING_PLAN.md` - LLM训练计划

---

### 3. 聊天气泡同步 ✅

#### 实现方案
- **同步机制**：语音播放事件回调
- **状态管理**：`speakingStates` Map跟踪播放状态
- **动画效果**：播放中脉冲动画 + 淡出动画

#### 核心特性
- ✅ 气泡与语音同时开始
- ✅ 语音播放完成后自动消失
- ✅ 播放中动画指示器
- ✅ 完善的错误处理和超时保护

#### 相关文档
- `CHAT_BUBBLE_SYNC_IMPLEMENTATION.md` - 聊天气泡同步实现

---

### 4. 方言映射系统 ✅

#### 架构设计
```
实时转换（映射表）
  ↓ 快速、同步
南昌话文本

训练模式（LLM）
  ↓ 批量生成
映射对
  ↓ 添加到映射表
扩展映射表
```

#### 核心特性
- ✅ 映射表转换（同步、快速）
- ✅ LLM训练模式（批量生成映射对）
- ✅ 本地存储持久化
- ✅ 从训练数据中提取文本

#### 相关文档
- `DIALECT_MAPPING_TRAINING.md` - 方言映射训练方案
- `NANCHANG_DIALECT_IMPLEMENTATION.md` - 南昌话实现

#### 使用方式
```javascript
// 实时转换（映射表）
const nanchangText = convertToNanchangDialect('厉害'); // '恰噶'

// 训练映射
const samples = window.trainingDataCollector.getAllSamples();
const result = await window.dialectMappingTrainer.batchTrain(samples);
```

---

### 5. 训练数据收集 ✅

#### 数据格式
```typescript
interface TrainingSample {
  timestamp: number;
  playerId: number;
  playerName: string;
  eventType: string;
  prompt: string;
  originalContent: string;
  processedContent: string;
  processingStats: {
    originalLength: number;
    processedLength: number;
    reduction: number;
    reductionPercent: number;
  };
  context?: any;
}
```

#### 核心特性
- ✅ 自动收集LLM处理流程数据
- ✅ 导出JSON/CSV格式
- ✅ 统计分析功能
- ✅ 最多保存1000条样本

#### 相关文档
- `TRAINING_DATA_GUIDE.md` - 训练数据收集指南

---

## 当前架构

### 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                      游戏事件触发                              │
│              (出牌、发牌、得分、对骂等)                        │
└────────────────────────────┬──────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    LLM聊天处理服务层                           │
│                  (LLMChatStrategy)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 提示词构建    │  │  LLM调用     │  │ 内容后处理    │     │
│  │ (Prompt)     │─▶│  (Ollama)    │─▶│ (Processor)   │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└────────────────────────────┬──────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    训练数据收集器                             │
│              (TrainingDataCollector)                        │
└────────────────────────────┬──────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│                    聊天消息输出                              │
│                  (ChatMessage)                              │
└────────────────────────────┬──────────────────────────────────┘
                             │
        ┌────────────────────┼────────────────────┐
        │                    │                    │
        ▼                    ▼                    ▼
┌──────────────┐    ┌──────────────┐    ┌──────────────┐
│  文本显示    │    │  方言映射    │    │  多声道播放  │
│  (气泡UI)    │    │ (DialectMap) │    │ (MultiChannel)│
└──────────────┘    └──────────────┘    └──────────────┘
```

### 文件结构

```
src/
├── services/
│   ├── multiChannelVoiceService.ts      # 多声道语音服务
│   ├── voiceService.ts                 # 语音服务包装
│   ├── chatService.ts                  # 聊天服务
│   ├── trainingDataCollector.ts        # 训练数据收集
│   └── translationService.ts           # 翻译服务
│
├── chat/
│   └── strategy/
│       ├── LLMChatStrategy.ts          # LLM聊天策略
│       └── RuleBasedStrategy.ts        # 规则策略
│
├── utils/
│   ├── nanchangDialectMapper.ts        # 南昌话映射
│   └── dialectMappingTrainer.ts       # 方言映射训练
│
├── hooks/
│   └── useChatBubbles.ts               # 聊天气泡Hook
│
└── components/
    ├── ChatBubble.tsx                   # 聊天气泡组件
    └── game/
        └── ChatBubblesContainer.tsx     # 气泡容器
```

---

## 短期开发计划（1-2个月）

### 1. 性能优化 ✅ 已完成
- [x] LLM请求队列和并发控制
- [x] 请求去重和缓存
- [x] 超时时间优化
- [x] 气泡清理优化

### 2. 功能完善
- [ ] **方言映射扩展**
  - 从训练数据中批量提取文本
  - 使用LLM训练生成更多映射对
  - 手动审核和添加高质量映射
  - 目标：扩展到500+映射对

- [ ] **聊天内容优化**
  - 优化LLM prompt，减少后处理
  - 提高对骂内容质量
  - 增加游戏场景相关聊天

- [ ] **多语言支持增强**
  - 完善翻译服务
  - 支持更多语言
  - 优化翻译缓存

### 3. 测试和稳定性
- [ ] **单元测试**
  - 方言映射测试
  - LLM请求队列测试
  - 气泡同步测试

- [ ] **集成测试**
  - 完整聊天流程测试
  - 多声道播放测试
  - 错误处理测试

- [ ] **性能测试**
  - LLM响应时间监控
  - 内存使用监控
  - 队列长度监控

---

## 中期开发计划（3-6个月）

### 1. 多声道语音增强

#### 方案A：TTS API + Web Audio API（推荐）
- **目标**：实现真正的多声道音频
- **技术**：
  - 使用在线TTS API（Google TTS、Azure TTS等）生成音频文件
  - 使用Web Audio API播放到不同声道
  - 音频缓存机制
- **优势**：
  - 真正的多声道
  - 音质好
  - 可以缓存
- **成本**：需要API密钥（可能有费用）

#### 方案B：本地TTS + Web Audio API
- **目标**：免费实现多声道
- **技术**：
  - 使用本地TTS库（如eSpeak、Festival）
  - 生成音频文件
  - 使用Web Audio API播放
- **优势**：
  - 完全免费
  - 离线可用
- **劣势**：
  - 音质可能不如在线TTS
  - 需要集成本地TTS库

### 2. LLM模型优化

#### 模型微调
- **目标**：训练专门的聊天模型
- **数据**：使用收集的训练数据
- **方法**：
  - 使用Ollama的模型微调功能
  - 或使用LoRA等轻量级微调方法
- **预期效果**：
  - 生成内容更符合游戏场景
  - 减少后处理需求
  - 提高响应速度

#### Prompt工程优化
- **目标**：减少后处理，提高生成质量
- **方法**：
  - 分析训练数据，找出常见问题
  - 优化system prompt
  - 添加更多示例
- **预期效果**：
  - 生成内容更简洁
  - 更符合要求（15字以内）

### 3. 方言支持扩展

#### 支持更多方言
- **目标**：支持5-10种常见方言
- **方法**：
  - 为每种方言创建映射表
  - 使用LLM训练生成映射对
  - 手动审核和优化
- **方言列表**：
  - 南昌话 ✅
  - 粤语
  - 上海话
  - 四川话
  - 东北话
  - 台湾话

#### 方言语音包（文本映射）
- **目标**：为每种方言建立完整的映射表
- **方法**：
  - 批量训练映射对
  - 建立方言词典
  - 支持短语映射（不仅仅是单词）

---

## 长期开发计划（6-12个月）

### 1. 多模态方言语音包训练系统 🆕

#### 方案概述

**目标**：使用本地多模态模型，通过网络视频训练方言语音包，实现真正的方言TTS。

详细方案请参考文档中的"多模态方言语音包训练方案"部分。

### 2. 游戏功能扩展

#### AI策略优化
- **目标**：使用MCTS等算法优化AI玩家策略
- **方法**：
  - 实现MCTS算法
  - 训练强化学习模型
  - 多策略融合

#### 多人联机
- **目标**：支持在线多人对战
- **技术**：
  - WebSocket实时通信
  - 房间系统
  - 匹配系统

#### 数据分析和可视化
- **目标**：游戏数据分析和可视化
- **功能**：
  - 玩家统计
  - 游戏记录
  - 数据分析仪表板

---

## 总结

### 已完成 ✅
1. 多声道语音系统（模拟实现）
2. LLM聊天系统（完整流程）
3. 聊天气泡同步
4. 方言映射系统（南昌话）
5. 训练数据收集

### 进行中 🚧
1. 方言映射扩展
2. 性能优化
3. 测试完善

### 计划中 📋
1. 多模态方言语音包训练系统（长期）
2. 多声道语音增强（TTS API方案）
3. LLM模型微调
4. 更多方言支持

### 核心优势
- ✅ **完全免费**：使用浏览器API和本地LLM
- ✅ **可扩展**：模块化架构，易于添加功能
- ✅ **可训练**：完整的数据收集和训练流程
- ✅ **创新性**：多模态方言语音包训练是独特功能

---

**最后更新**：2024-12-19

