# 聊天性能优化

## 🔧 优化内容

### 1. LLM调用优化

**问题**：密集聊天时，大量LLM请求导致超时和阻塞。

**解决方案**：
- ✅ **南昌话转换超时缩短**：从60秒降到5秒
- ✅ **并发限制**：最多同时2个LLM转换请求
- ✅ **快速回退**：超时或失败时立即使用映射表，不等待

**修改文件**：
- `src/utils/nanchangDialectMapper.ts`

### 2. 气泡清理优化

**问题**：气泡显示很多，要过很久才消除。

**解决方案**：
- ✅ **缩短超时时间**：
  - 未开始播放：5秒后自动隐藏（从10秒降到5秒）
  - 未结束播放：8秒后自动隐藏（从10秒降到8秒）
- ✅ **失败立即隐藏**：语音播放失败时立即隐藏，不等待
- ✅ **无语音配置**：2秒后自动隐藏（从3秒降到2秒）

**修改文件**：
- `src/components/ChatBubble.tsx`
- `src/hooks/useChatBubbles.ts`

## 📊 优化效果

### LLM调用

**之前**：
- 超时时间：60秒
- 无并发限制
- 超时后等待60秒才回退

**现在**：
- 超时时间：5秒（南昌话转换）
- 并发限制：最多2个同时请求
- 超时后立即回退到映射表

### 气泡显示

**之前**：
- 未开始播放：10秒后隐藏
- 未结束播放：10秒后隐藏
- 播放失败：3秒后隐藏
- 无语音配置：3秒后隐藏

**现在**：
- 未开始播放：5秒后隐藏
- 未结束播放：8秒后隐藏
- 播放失败：立即隐藏
- 无语音配置：2秒后隐藏

## 🎯 性能提升

1. **响应速度**：气泡更快消失，界面更流畅
2. **资源占用**：减少LLM请求数量，降低服务器压力
3. **用户体验**：避免气泡堆积，界面更清爽

## 🔍 调试

### 查看LLM转换状态

```
[NanchangDialectMapper] LLM转换队列已满，快速回退到映射表
[NanchangDialectMapper] LLM转换超时（5秒），快速回退到映射表
```

### 查看气泡清理

```
[ChatBubble] 5秒内未开始播放，自动隐藏
[ChatBubble] 8秒内未结束播放，自动隐藏
```

## ⚙️ 配置参数

### LLM转换并发限制

在 `src/utils/nanchangDialectMapper.ts` 中：

```typescript
const MAX_CONCURRENT_LLM_CONVERSIONS = 2; // 最多同时2个LLM转换请求
```

### 超时时间

```typescript
// 南昌话转换超时（5秒）
setTimeout(() => controller.abort(), 5000);

// 气泡未开始播放超时（5秒）
setTimeout(() => { ... }, 5000);

// 气泡未结束播放超时（8秒）
setTimeout(() => { ... }, 8000);
```

## 🚀 未来优化建议

1. **请求去重**：相同文本的转换请求只发送一次
2. **智能队列**：根据优先级调整请求顺序
3. **批量转换**：将多个转换请求合并为一次调用
4. **本地缓存**：持久化缓存转换结果

---

**更新日期**：2024-12-19

