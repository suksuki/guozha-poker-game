# LLM请求队列优化

## 🔧 优化内容

### 问题分析

从日志看，主要问题是：
1. **LLM API响应时间过长**（27-34秒），导致大量请求堆积
2. **无并发控制**：所有LLM请求同时发送，导致Ollama服务器过载
3. **对骂消息丢失**：虽然生成了，但因为超时或阻塞没有播放
4. **气泡堆积**：大量气泡显示，很久才消失

### 解决方案

#### 1. LLM请求队列和并发控制

**实现**：
- ✅ 添加请求队列：`llmRequestQueue`
- ✅ 并发限制：最多同时2个LLM请求（`MAX_CONCURRENT_LLM_REQUESTS = 2`）
- ✅ 优先级排序：对骂（3）> 事件（2）> 随机（1）
- ✅ 队列长度限制：最多20个请求，超过时丢弃低优先级请求

**修改文件**：
- `src/chat/strategy/LLMChatStrategy.ts`

#### 2. 请求去重和缓存

**实现**：
- ✅ 请求去重：相同prompt只发送一次请求
- ✅ 结果缓存：5秒内相同prompt使用缓存结果
- ✅ 等待机制：如果相同prompt正在处理，等待结果而不是重复请求

#### 3. 超时时间优化

**实现**：
- ✅ LLM请求超时：从60秒降到20秒（`LLM_REQUEST_TIMEOUT = 20000`）
- ✅ 南昌话转换超时：5秒（已实现）
- ✅ 快速失败：超时后立即回退，不等待

#### 4. 气泡清理优化

**实现**：
- ✅ 未开始播放：5秒后自动隐藏
- ✅ 未结束播放：8秒后自动隐藏
- ✅ 播放失败：立即隐藏
- ✅ 无语音配置：2秒后自动隐藏

## 📊 优化效果

### LLM请求管理

**之前**：
- 无并发限制，所有请求同时发送
- 超时时间60秒，导致长时间阻塞
- 无优先级，对骂和随机请求同等处理
- 无去重，相同prompt重复请求

**现在**：
- 并发限制：最多2个同时请求
- 超时时间：20秒（从60秒降到20秒）
- 优先级排序：对骂优先处理
- 请求去重：相同prompt只请求一次
- 结果缓存：5秒内使用缓存

### 请求流程

```
LLM请求
  ↓
检查是否正在处理相同prompt
  ├─> 是 → 等待结果
  └─> 否 → 检查并发数
      ├─> 未满 → 立即执行
      └─> 已满 → 加入队列（按优先级排序）
          ↓
      队列处理
          ├─> 检查缓存
          ├─> 执行请求
          └─> 缓存结果
```

### 优先级

| 类型 | 优先级 | 说明 |
|------|--------|------|
| 对骂 | 3 | 最高优先级，优先处理 |
| 事件 | 2 | 中等优先级 |
| 随机 | 1 | 最低优先级 |

## 🔍 调试日志

### 队列管理

```
[LLMChatStrategy] 加入LLM队列（队列长度: 5，优先级: 3）
[LLMChatStrategy] 使用缓存结果
[LLMChatStrategy] ⚠️ LLM队列已满，丢弃低优先级请求
```

### 响应时间警告

```
[LLMChatStrategy] ⚠️ LLM响应时间过长: 15000 ms，可能导致阻塞
```

### 气泡清理

```
[ChatBubble] 5秒内未开始播放，自动隐藏
[ChatBubble] 8秒内未结束播放，自动隐藏
```

## ⚙️ 配置参数

### LLM请求配置

```typescript
// src/chat/strategy/LLMChatStrategy.ts
private readonly MAX_CONCURRENT_LLM_REQUESTS = 2; // 最多同时2个请求
private readonly LLM_REQUEST_TIMEOUT = 20000; // 20秒超时
private readonly CACHE_TTL = 5000; // 缓存5秒
```

### 队列长度

```typescript
// 队列最多20个请求
if (this.llmRequestQueue.length >= 20) {
  // 丢弃低优先级请求
}
```

## 🚀 性能提升

1. **响应速度**：对骂消息优先处理，更快生成
2. **资源占用**：限制并发数，降低服务器压力
3. **用户体验**：避免阻塞，消息及时显示
4. **稳定性**：请求去重和缓存，减少重复请求

## 📝 注意事项

1. **队列溢出**：如果队列满，低优先级请求会被丢弃
2. **缓存时效**：缓存5秒，超过后重新请求
3. **超时处理**：20秒超时后立即回退到规则策略

---

**更新日期**：2024-12-19

