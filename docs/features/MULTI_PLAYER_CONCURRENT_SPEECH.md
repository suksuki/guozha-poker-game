# 多人同时说话功能

## 📋 功能概述

实现了多人同时说话的"伪并发"方案，允许最多 **2个玩家** 同时说话，营造真实的聊天氛围。

## 🎯 实现原理

由于浏览器的 `speechSynthesis` API 是单声道的，无法真正同时播放多个语音。我们通过以下方式实现"伪并发"：

1. **时间错开**：多个语音错开 150ms 播放，营造"同时说话"的感觉
2. **音量调整**：并发播放时，每个语音的音量降低到 75%，避免声音过大
3. **智能队列**：超过并发上限的语音会进入队列，等待播放

## ⚙️ 配置参数

在 `src/services/multiChannelVoiceService.ts` 中：

```typescript
// 并发播放控制
private maxConcurrentSpeakers: number = 2; // 最多同时播放2个玩家
private concurrentTimeOffset: number = 150; // 并发播放时间错开（毫秒）
```

### 可调整参数

- **`maxConcurrentSpeakers`**：最多同时播放的玩家数（默认：2）
  - 可以调整为 1-3，建议不超过 3（避免声音混乱）
  
- **`concurrentTimeOffset`**：时间错开间隔（默认：150ms）
  - 可以调整为 100-200ms，建议 150ms（既能营造同时感，又不会太混乱）

- **音量调整**：并发时音量降低到 75%
  - 可以在 `setupAudioParams` 方法中调整 `volumeMultiplier`

## 🔄 工作流程

### 场景：玩家0和玩家1同时说话

```
1. 玩家0开始说话
   ├─> 并发数：0/2
   ├─> 立即播放（第1个）
   └─> 并发数：1/2

2. 玩家1开始说话（在玩家0播放期间）
   ├─> 并发数：1/2（未满）
   ├─> 延迟 150ms 播放（时间错开）
   ├─> 音量降低到 75%
   └─> 并发数：2/2

3. 玩家2也想说话（在玩家0和玩家1播放期间）
   ├─> 并发数：2/2（已满）
   └─> 加入全局队列，等待播放

4. 玩家0播放完成
   ├─> 从并发集合移除
   ├─> 并发数：1/2
   └─> 触发全局队列处理，玩家2开始播放
```

## 📊 日志输出

系统会输出详细的日志，帮助调试：

```
[玩家0（左）] ✅ 立即播放（并发播放第1个）: 好牌！
[玩家1（右）] ✅ 允许并发播放（当前2/2），延迟 150ms: 要不起
[玩家2（左中）] ⏳ 并发数已达上限(2)，加入队列: 我也要不起
[玩家0（左）] 从并发播放集合移除，当前并发数: 1/2
[玩家2（左中）] 从全局队列中取出（并发数: 1/2）: 我也要不起
```

## 🎨 用户体验

### 效果

- ✅ **真实感**：多个玩家可以"同时"说话，营造真实的聊天氛围
- ✅ **清晰度**：通过时间错开和音量调整，保持语音清晰
- ✅ **流畅度**：智能队列管理，确保所有语音都能播放

### 限制

- ⚠️ **单声道限制**：由于浏览器限制，无法实现真正的多声道同时播放
- ⚠️ **并发上限**：最多同时播放 2 个玩家（可调整）
- ⚠️ **时间错开**：多个语音会有 150ms 的时间差（营造"同时"感）

## 🔧 调试技巧

### 1. 查看并发状态

在浏览器控制台：

```javascript
// 查看当前并发播放的玩家
console.log('并发播放:', multiChannelVoiceService.concurrentSpeakers);
```

### 2. 调整并发参数

在 `multiChannelVoiceService.ts` 中修改：

```typescript
// 增加并发数（最多3个）
this.maxConcurrentSpeakers = 3;

// 减少时间错开（更快）
this.concurrentTimeOffset = 100;

// 增加时间错开（更慢，但更清晰）
this.concurrentTimeOffset = 200;
```

### 3. 调整音量

在 `setupAudioParams` 方法中：

```typescript
// 并发时音量降低到 60%（更清晰）
const volumeMultiplier = concurrentCount > 1 ? 0.6 : 1.0;

// 并发时音量降低到 80%（更响亮）
const volumeMultiplier = concurrentCount > 1 ? 0.8 : 1.0;
```

## 📝 测试建议

1. **测试并发播放**
   - 让多个玩家快速连续说话
   - 观察是否能够"同时"播放

2. **测试队列管理**
   - 让3个以上玩家同时说话
   - 观察队列是否正确处理

3. **测试音量平衡**
   - 并发播放时，检查音量是否合适
   - 调整 `volumeMultiplier` 找到最佳平衡

## 🚀 未来优化

1. **动态调整**：根据语音长度动态调整并发数
2. **优先级**：重要消息优先播放
3. **智能混合**：使用 Web Audio API 实现真正的多声道混合（需要 TTS API）

---

**注意**：由于浏览器限制，这是目前最佳的"伪并发"方案。如果需要真正的多声道同时播放，需要使用在线 TTS API + Web Audio API。

