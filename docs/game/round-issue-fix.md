# Round 轮次问题修复

## 🐛 问题描述

开局第一轮，玩家2连续出了两轮，玩家3连续也是两轮。

## 🔍 问题分析

### 根本原因

在 `shouldTakeover()` 接风判断函数中，没有排除刚出牌的玩家，导致接风判断不准确。

### 问题场景

1. 玩家2出牌，`lastPlayPlayerIndex = 2`
2. 下一个玩家是玩家3
3. 检查接风时，没有排除玩家2（刚出牌的玩家）
4. 如果玩家2能打过自己的牌（逻辑上不应该，但判断时会被包含）
5. 导致接风判断错误，轮次没有正确结束

## ✅ 修复方案

### 1. 修复 `shouldTakeover()` 函数

**文件**: `src/utils/Round.ts`

**修复**:
- 在检查接风时，排除刚出牌的玩家（`lastPlayPlayerIndex`）
- 因为刚出牌的玩家肯定能打过自己的牌，不应该被包含在接风判断中

```typescript
shouldTakeover(players: Player[], currentPlayerIndex: number): boolean {
  // ...
  for (let i = 0; i < players.length; i++) {
    // ...
    // 跳过刚出牌的玩家（刚出牌的玩家肯定能打过自己的牌，不需要检查）
    if (i === this.lastPlayPlayerIndex) {
      continue;
    }
    // ...
  }
}
```

### 2. 优化接风判断逻辑

**文件**: `src/hooks/useMultiPlayerGame.ts`

**修复**:
- 先检查接风，再判断是否结束轮次
- 添加详细日志，方便调试
- 确保状态正确同步

### 3. 添加详细日志

在关键位置添加日志，帮助调试：
- 出牌完成后的状态
- 接风判断结果
- 轮次结束判断

## 📝 修复后的流程

1. **玩家出牌后**
   - 计算下一个玩家
   - 检查是否需要接风（排除刚出牌的玩家）
   - 如果需要接风，清空 `lastPlay`

2. **更新状态**
   - 同步 Round 对象的状态
   - 更新 `currentPlayerIndex`

3. **检查是否结束轮次**
   - 在接风检查之后判断
   - 如果下一个玩家是最后出牌的人，结束轮次

## ✅ 预期效果

修复后，应该：
- ✅ 正确判断接风（排除刚出牌的玩家）
- ✅ 正确判断轮次是否应该结束
- ✅ 不会出现玩家连续出两轮的情况
- ✅ 状态正确同步

## 🧪 测试建议

1. 测试接风场景：玩家出牌后，所有其他玩家都要不起
2. 测试轮次结束：所有人都要不起后，轮次正确结束
3. 测试正常流程：玩家轮流出牌，不会连续出两轮
4. 查看控制台日志，确认逻辑正确

