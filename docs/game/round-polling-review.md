# 轮次轮询流程 Review

## 📋 目标

确保：
1. ✅ 所有玩家都被轮询（包括真实玩家）
2. ✅ 真实玩家思考时有等待机制
3. ✅ 超时机制正常工作
4. ✅ 轮询完成后才判断接风

## 🔍 当前流程分析

### 1. 玩家出牌后 (`onPlayCompleted`)

**位置**: `src/utils/roundScheduler.ts:269`

**流程**：
1. 玩家A出牌后，调用 `onPlayCompleted`
2. 计算下一个玩家B：`nextPlayerIndex = findNextActivePlayer(playerIndex, players, playerCount)`
3. **不检查接风**（第339-342行注释说明：需要等待其他玩家轮询）
4. 更新状态，设置 `currentPlayerIndex = nextPlayerIndex`
5. 检查轮次是否应该结束（如果 `nextPlayerIndex === lastPlayPlayerIndex`）
6. 继续下一家：如果是AI或托管模式，自动继续

**问题**：
- ✅ 不提前检查接风（正确）
- ⚠️ 需要确认：真实玩家是否被正确轮询到

### 2. 玩家要不起后 (`onPassCompleted`)

**位置**: `src/utils/roundScheduler.ts:433`

**流程**：
1. 玩家B要不起后，调用 `onPassCompleted`
2. 计算下一个玩家C：`nextPlayerIndex = findNextActivePlayer(playerIndex, players, playerCount)`
3. **检查接风**：
   - **唯一情况**（第468行）：如果 `nextPlayerIndex === lastPlayPlayerIndex`，说明轮了一圈，所有人都要不起 → **接风**
   - ❌ **已删除提前接风判断**（原第552行）：提前接风逻辑不合理，已删除
4. 如果接风，结束本轮，开启新轮次，由出牌玩家接风
5. 如果不接风，继续下一家

**关键点**：
- ✅ 接风判断只在轮完一圈后进行（`nextPlayerIndex === lastPlayPlayerIndex`）
- ⚠️ **需要确认**：当 `nextPlayerIndex === lastPlayPlayerIndex` 时，是否真的所有玩家都已操作（或超时）？
  - 如果玩家A出牌，玩家B、C、D都要不起，下一个应该是玩家A
  - **关键问题**：是否所有玩家（B、C、D）都已经完成了操作？
  - 特别是真实玩家：是否已操作或已超时？

### 3. 真实玩家等待机制 (`playNextTurnInternal`)

**位置**: `src/hooks/useMultiPlayerGame.ts:328`

**流程**：
1. 当轮到真实玩家时，启动超时机制
2. 设置超时时间（默认30秒）：`timeout = latestGameConfig.timingConfig?.playTimeout || 30000`
3. 等待玩家操作或超时
4. 超时后自动处理（AI出牌或自动要不起）

**问题**：
- ✅ 有超时机制
- ✅ 超时后会自动处理
- ⚠️ **关键问题**：真实玩家操作完成后，是否确保所有其他玩家也轮询了？

## 🐛 潜在问题

### 问题1：接风判断时机

**场景**：
- 玩家A出牌
- 玩家B（真实玩家）需要思考 → 等待30秒
- 玩家C要不起
- 玩家D要不起
- **此时**：`nextPlayerIndex === lastPlayPlayerIndex`（玩家A）
- **问题**：玩家B还没操作，就判断接风了？

**需要检查**：
- 在判断接风之前，是否确保所有玩家都已经操作（或超时）？

### 问题2：轮询顺序

**场景**：
- 玩家A出牌
- 玩家B、C、D都要不起
- 轮询顺序：B → C → D → A
- **问题**：如果B是真实玩家，正在思考，是否会正确等待？

**需要检查**：
- 每个玩家操作后，是否等待下一个玩家完成操作，再继续？

### 问题3：提前接风判断 ❌ 已删除

**位置**: `src/utils/roundScheduler.ts:552`（已删除）

**问题**：
- ❌ 提前接风逻辑不合理：只检查手牌，不检查轮询状态
- ❌ 可能还有玩家没被轮询到（如真实玩家正在思考），就错误地提前判断接风
- ❌ 应该等待所有玩家都操作（或超时）后再判断接风

**修复**：
- ✅ **已删除提前接风判断逻辑**
- ✅ 现在接风判断只在轮完一圈后进行（`nextPlayerIndex === lastPlayPlayerIndex`）
- ✅ 确保所有玩家都有机会操作后再判断接风

## ✅ 需要Review的点

### 1. 确保所有玩家都轮询

**检查点**：
- [ ] `findNextActivePlayer` 是否正确找到下一个玩家？
- [ ] 已出完牌的玩家是否被正确跳过？
- [ ] 轮询是否真的轮了一圈？

### 2. 真实玩家等待机制

**检查点**：
- [ ] 真实玩家的超时机制是否正常工作？
- [ ] 真实玩家操作完成后，是否继续轮询下一个玩家？
- [ ] 如果真实玩家超时，自动处理后是否继续轮询？

### 3. 接风判断时机

**检查点**：
- [x] ✅ 接风判断只在轮完一圈后进行（已删除提前接风判断）
- [ ] `nextPlayerIndex === lastPlayPlayerIndex` 时，是否真的轮了一圈且所有玩家都已操作？
- [ ] 真实玩家在思考时，是否会被正确等待，不会提前判断接风？

### 4. 状态同步

**检查点**：
- [ ] 每个玩家操作后，状态是否正确更新？
- [ ] 真实玩家操作时，状态是否同步？
- [ ] 超时自动处理后，状态是否正确更新？

## 🔧 建议的改进

### 改进1：明确轮询状态跟踪

在 `RoundScheduler` 中跟踪：
- 哪些玩家已经被轮询过
- 哪些玩家正在等待（真实玩家）
- 哪些玩家已经操作（出牌或要不起）

### 改进2：接风判断前确认所有玩家都操作过

在判断接风之前：
1. 确认所有玩家都已经操作（或超时）
2. 如果有玩家还在等待，不判断接风

### 改进3：改进日志

添加详细日志，记录：
- 每个玩家的轮询状态
- 接风判断时的所有玩家状态
- 真实玩家等待和超时情况

## 📝 下一步行动

1. ✅ 检查 `shouldTakeover` 方法，确保排除逻辑正确
2. ✅ 检查 `onPassCompleted` 中的接风判断逻辑
3. ✅ 检查真实玩家等待机制，确保不会跳过
4. ✅ 添加更详细的日志，追踪轮询状态
5. ✅ 测试场景：真实玩家在思考时，是否会被正确等待

