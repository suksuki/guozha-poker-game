# LLM 重构功能测试指南

## 📋 测试用例概览

已创建两个主要测试文件：
1. `tests/services/llm/OllamaServerManager.test.ts` - 服务器管理器测试 (15+ 测试用例)
2. `tests/services/llm/LLMAvailabilityManager.test.ts` - 可用性管理器测试 (20+ 测试用例)

## 🧪 测试覆盖范围

### OllamaServerManager 测试

#### 1. 初始化测试
- ✅ 加载预设的本地服务器
- ✅ 默认当前服务器设置

#### 2. 添加服务器测试
- ✅ 添加新服务器
- ✅ 自动生成服务器名称
- ✅ 持久化到 localStorage

#### 3. 删除服务器测试
- ✅ 删除自定义服务器
- ✅ 保护本地服务器不被删除
- ✅ 删除当前服务器自动切换

#### 4. 切换服务器测试
- ✅ 切换到存在的服务器
- ✅ 更新最后使用时间
- ✅ 防止切换到不存在的服务器

#### 5. 收藏功能测试
- ✅ 收藏/取消收藏
- ✅ 获取收藏列表

#### 6. 最近使用测试
- ✅ 按时间排序
- ✅ 限制返回数量

#### 7. URL 生成测试
- ✅ 服务器 URL
- ✅ API URL
- ✅ Tags URL
- ✅ HTTPS 支持

#### 8. 地址解析测试
- ✅ 简单 IP
- ✅ IP:端口
- ✅ 域名
- ✅ 完整 HTTP/HTTPS URL

#### 9. 状态更新测试
- ✅ 更新可用状态
- ✅ 标记不可用

---

### LLMAvailabilityManager 测试

#### 1. 初始状态测试
- ✅ 验证 unknown 初始状态

#### 2. 可用性检测测试
- ✅ 成功检测返回 available
- ✅ 失败检测返回 unavailable
- ✅ HTTP 错误处理
- ✅ 检测中状态

#### 3. 结果缓存测试
- ✅ 缓存检测结果
- ✅ 强制检测忽略缓存
- ✅ 多服务器独立缓存

#### 4. 缓存状态获取测试
- ✅ 获取已缓存状态
- ✅ 未缓存返回 unknown

#### 5. 延迟测量测试
- ✅ 记录请求延迟
- ✅ 失败请求不记录

#### 6. 手动标记测试
- ✅ 手动标记不可用
- ✅ 更新全局状态

#### 7. 重置状态测试
- ✅ 重置特定服务器
- ✅ 重置所有状态

#### 8. shouldUseLLM 判断测试
- ✅ available 返回 true
- ✅ unavailable 返回 false
- ✅ unknown 状态处理

#### 9. 配置测试
- ✅ 设置超时时间
- ✅ 设置缓存时间
- ✅ 清除过期缓存

---

## 🚀 运行测试

### 方法 1：运行特定测试
```bash
npm test -- tests/services/llm/OllamaServerManager.test.ts
npm test -- tests/services/llm/LLMAvailabilityManager.test.ts
```

### 方法 2：运行所有 LLM 测试
```bash
npm test -- tests/services/llm/
```

### 方法 3：在 WSL 中运行
```bash
wsl bash -c "cd /home/jin/guozha_poker_game && npm test -- tests/services/llm/"
```

---

## 🧪 手动功能测试清单

### 1. 服务器管理功能
- [ ] 启动应用，打开游戏配置
- [ ] 进入"聊天/语音配置"
- [ ] 验证本地服务器显示正确
- [ ] 尝试添加远程服务器 (192.168.0.13)
- [ ] 验证服务器状态检测
- [ ] 切换服务器并验证模型列表更新
- [ ] 收藏/取消收藏服务器
- [ ] 删除自定义服务器

### 2. LLM 可用性检测
- [ ] 关闭本地 Ollama 服务
- [ ] 启动应用，验证自动检测为"不可用"
- [ ] 验证状态显示："🔴 LLM 不可用 - 使用预设聊天"
- [ ] 启动游戏，验证聊天使用预设模板（无超时等待）
- [ ] 启动 Ollama 服务
- [ ] 手动点击"检测服务器"
- [ ] 验证状态变为"🟢 LLM 可用"

### 3. 智能降级测试
- [ ] LLM 可用时开始游戏
- [ ] 观察 AI 聊天使用 LLM 生成
- [ ] 游戏进行中关闭 Ollama 服务
- [ ] 验证后续聊天自动切换到预设模板
- [ ] 验证无超时等待（零延迟切换）

### 4. 服务器切换测试
- [ ] 添加两个服务器（本地 + 192.168.0.13）
- [ ] 在游戏配置中切换服务器
- [ ] 验证 API URL 自动更新
- [ ] 验证模型列表重新加载
- [ ] 验证"最近使用"列表排序正确

### 5. 持久化测试
- [ ] 添加多个服务器
- [ ] 收藏部分服务器
- [ ] 关闭并重新打开应用
- [ ] 验证所有服务器配置保留
- [ ] 验证收藏状态保留
- [ ] 验证当前选中的服务器保留

---

## 🐛 已知问题和修复

### 问题 1: ollamaAvailable 未定义 ✅ 已修复
**错误**: `ReferenceError: ollamaAvailable is not defined`

**原因**: 移除了 `ollamaAvailable` 状态变量，但在配置卡片摘要中仍在使用

**修复**: 将 `ollamaAvailable` 替换为 `llmAvailability === 'available'`

**文件**: `src/components/game/GameConfigPanel.tsx` (第 413-416 行)

---

## ✅ 测试通过标准

### 单元测试
- [ ] 所有测试用例通过
- [ ] 无 linter 错误
- [ ] 代码覆盖率 > 80%

### 集成测试
- [ ] 服务器添加/删除/切换正常
- [ ] LLM 检测正确识别可用性
- [ ] 降级机制无延迟切换
- [ ] 持久化正常工作

### 用户体验
- [ ] UI 状态提示清晰
- [ ] 操作流畅无卡顿
- [ ] 错误提示友好
- [ ] 配置保存可靠

---

## 📊 性能基准

### 启动时间
- **无 LLM 环境**: < 2秒完成检测
- **有 LLM 环境**: < 1秒完成检测

### 运行时性能
- **LLM 不可用时**: 0ms 等待（立即降级）
- **切换服务器**: < 3秒完成检测

### 内存使用
- **缓存大小**: ~1KB per server
- **总体影响**: < 10KB

---

## 🎯 下一步计划

1. **完善 i18n 翻译**: 添加英文、日文、韩文翻译
2. **添加 E2E 测试**: 使用 Playwright 测试完整流程
3. **性能监控**: 添加检测时间和延迟统计
4. **错误恢复**: 优化网络错误重试机制
5. **UI 优化**: 添加更多动画和反馈

---

## 📝 测试报告模板

```markdown
## 测试日期: YYYY-MM-DD
## 测试人员: [Your Name]

### 环境
- 操作系统: Windows 11 + WSL Ubuntu
- Node 版本: [version]
- 浏览器: Chrome [version]

### 测试结果
- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 手动测试通过

### 发现的问题
1. [问题描述]
   - 严重程度: [高/中/低]
   - 复现步骤: ...
   - 预期结果: ...
   - 实际结果: ...

### 性能数据
- 启动检测时间: [X]ms
- 切换服务器时间: [X]ms
- 内存使用: [X]MB

### 备注
[其他观察和建议]
```

