# LLM提示词和后处理增强

## 📋 改进内容

### 1. 提示词构建增强

#### ✅ 已实现

1. **完整的游戏规则说明**（首次调用时）
   - 基本规则（牌型、分牌、墩的计分等）
   - 聊天规则（内容要求、风格要求等）

2. **玩家信息部分**
   - 当前玩家名字、ID、性格
   - 其他玩家信息（名字、ID、性格）

3. **完整的游戏状态**
   - 轮次、阶段、得分
   - 手牌数量
   - 最近出牌
   - 出牌历史

4. **当前情况描述**
   - 决策信息
   - 游戏事件
   - 局面分析

5. **提示词验证和预处理**
   - 长度检查（最大2000字符）
   - 危险字符过滤
   - 格式规范化

### 2. LLM返回处理增强

#### ✅ 已实现

1. **基础清理**
   - 移除引号
   - 移除标记（如"聊天内容："、"回复："等）
   - 移除换行和多余空格

2. **内容过滤**
   - 敏感词过滤（可扩展）
   - HTML标签移除
   - 代码标记移除

3. **格式验证**
   - 空白字符检查
   - 特殊字符比例检查
   - 长度控制（最多15个字符）

4. **错误恢复**
   - 如果返回无效，返回空字符串
   - 触发规则生成作为回退

## 🔧 实现细节

### 提示词结构

```
【游戏规则：过炸/争上游】
（首次调用时包含）

【玩家信息】
- 你的名字、ID、性格
- 其他玩家信息

【当前游戏状态】
- 轮次、阶段、得分
- 手牌数量
- 最近出牌
- 出牌历史

【当前情况】
- 决策信息
- 游戏事件
- 局面分析

【输出要求】
- 性格描述
- 输出格式要求
- 示例
```

### 返回处理流程

```
LLM返回
  ↓
基础清理（移除引号、标记等）
  ↓
内容过滤（敏感词、HTML、代码标记）
  ↓
长度控制（最多15个字符）
  ↓
格式验证（空白、特殊字符检查）
  ↓
如果有效 → 返回内容
如果无效 → 返回空字符串 → 触发规则生成
```

## 📝 使用方式

### 设置玩家名字

```typescript
// 在 MasterAIBrain 初始化时
commScheduler.setPlayerName(playerId, playerName);
```

### 重置游戏规则（新游戏开始时）

```typescript
// 新游戏开始时
commScheduler.resetGameRules();
```

## 🎯 优势

1. **更准确的聊天生成**：LLM有完整的上下文信息
2. **更安全的输出**：内容过滤和验证
3. **更好的用户体验**：包含玩家名字，更个性化
4. **自动回退**：如果LLM返回无效，自动使用规则生成

## ⚠️ 注意事项

1. **提示词长度**：首次调用时提示词较长（包含游戏规则），后续调用会较短
2. **玩家名字**：需要在初始化时设置，否则使用默认名字（"玩家X"）
3. **敏感词列表**：目前为空，可以根据需要扩展
4. **游戏规则重置**：新游戏开始时需要调用 `resetGameRules()`

