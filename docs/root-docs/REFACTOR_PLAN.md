# useMultiPlayerGame.ts 重构计划

## 当前状态
- 文件大小：~3261 行
- 主要问题：
  1. 游戏结束逻辑重复了3次（约150行 × 3 = 450行重复代码）
  2. 大量内联逻辑，缺少函数提取
  3. 验证逻辑分散在多处
  4. 缺少单元测试

## 重构步骤

### ✅ 步骤1：提取游戏结束逻辑（已完成）
- 创建 `src/utils/gameEndHandler.ts`
- 统一处理游戏结束逻辑
- 减少约 450 行重复代码

### 🔄 步骤2：替换所有游戏结束调用
- [x] 替换第一个游戏结束位置（playNextTurn 中）
- [ ] 替换第二个游戏结束位置（AI fallback 1）
- [ ] 替换第三个游戏结束位置（AI fallback 2）

### 📋 步骤3：提取其他重复逻辑
- [ ] 提取验证逻辑到独立函数
- [ ] 提取轮次结束处理逻辑
- [ ] 提取玩家出牌处理逻辑
- [ ] 提取AI出牌处理逻辑

### 🧹 步骤4：清理代码
- [ ] 删除未使用的导入
- [ ] 删除注释掉的代码
- [ ] 统一代码风格
- [ ] 优化变量命名

### 🧪 步骤5：创建测试框架
- [ ] 安装测试依赖（vitest/jest）
- [ ] 创建测试目录结构
- [ ] 编写 `gameEndHandler` 的单元测试
- [ ] 编写关键函数的单元测试

### ✅ 步骤6：回归测试
- [ ] 测试游戏正常结束
- [ ] 测试末游玩家剩余手牌处理
- [ ] 测试分数计算正确性
- [ ] 测试牌数验证

## 预期收益
- 代码行数减少：~500-800 行
- 可维护性提升：重复代码减少 80%
- 可测试性提升：关键逻辑可独立测试
- 代码质量提升：更清晰的函数职责

