# ğŸŒ å¤–ç½‘è®¿é—®é…ç½®å®Œæ•´æŒ‡å—

> **é…ç½®æ—¥æœŸ**: 2025å¹´12æœˆ4æ—¥  
> **é…ç½®äºº**: hlsystem  
> **æœåŠ¡å™¨**: server4 (192.168.0.13)  
> **å…¬ç½‘IP**: 115.93.10.51  

## ğŸ“‹ é…ç½®æ¦‚è¿°

æœ¬æŒ‡å—è®°å½•äº†å¦‚ä½•é…ç½® MeLo TTS å’Œ Ollama æœåŠ¡çš„å¤–ç½‘è®¿é—®ï¼Œä½¿å¾—å¯ä»¥ä»ä»»ä½•åœ°æ–¹é€šè¿‡å…¬ç½‘IPè®¿é—®è¿™äº›æœåŠ¡ã€‚

### æœåŠ¡ä¿¡æ¯

| æœåŠ¡ | å†…ç½‘åœ°å€ | å¤–ç½‘åœ°å€ | ç«¯å£ | çŠ¶æ€ |
|------|---------|---------|------|------|
| **MeLo TTS** | http://192.168.0.13:7860 | http://115.93.10.51:7860 | 7860 | âœ… è¿è¡Œä¸­ |
| **Ollama** | http://192.168.0.13:11434 | http://115.93.10.51:11434 | 11434 | âœ… è¿è¡Œä¸­ |

### å¯ç”¨æ¨¡å‹

- qwen2:0.5b
- qwen2.5:3b
- qwen:4b-chat
- nomic-embed-text:latest
- bge-m3:latest

---

## ğŸ¯ é…ç½®æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹å…¬ç½‘IP

```bash
# åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
curl ifconfig.me
```

**è¾“å‡º**: `115.93.10.51`

### ç¬¬äºŒæ­¥ï¼šé…ç½® Ollama æœåŠ¡

ç¡®ä¿ Ollama ç›‘å¬æ‰€æœ‰IPåœ°å€ï¼ˆ0.0.0.0ï¼‰è€Œä¸æ˜¯åªç›‘å¬ localhostã€‚

```bash
# åˆ›å»º systemd æœåŠ¡é…ç½®
sudo tee /etc/systemd/system/ollama.service > /dev/null << 'EOF'
[Unit]
Description=Ollama LLM Service
After=network.target

[Service]
Type=simple
User=ollama
Environment="OLLAMA_HOST=0.0.0.0:11434"
ExecStart=/usr/local/bin/ollama serve
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# é‡æ–°åŠ è½½å¹¶å¯åŠ¨
sudo systemctl daemon-reload
sudo systemctl enable ollama
sudo systemctl restart ollama
```

**éªŒè¯ç›‘å¬åœ°å€**:
```bash
sudo ss -tlnp | grep 11434
# åº”è¯¥æ˜¾ç¤º: *:11434 (è¡¨ç¤ºç›‘å¬æ‰€æœ‰IP)
```

### ç¬¬ä¸‰æ­¥ï¼šé…ç½® MeLo TTS æœåŠ¡

MeLo TTS å·²ç»è¿è¡Œåœ¨ screen ä¼šè¯ä¸­ï¼Œé»˜è®¤ç›‘å¬ 0.0.0.0:7860ã€‚

**æŸ¥çœ‹è¿è¡ŒçŠ¶æ€**:
```bash
# æŸ¥çœ‹ screen ä¼šè¯
screen -ls
# åº”è¯¥æ˜¾ç¤º: melo

# è¿æ¥åˆ°ä¼šè¯ï¼ˆæŸ¥çœ‹æ—¥å¿—ï¼‰
screen -r melo
# æŒ‰ Ctrl+A ç„¶å D é€€å‡ºï¼ˆä¸åœæ­¢ç¨‹åºï¼‰
```

**éªŒè¯ç›‘å¬åœ°å€**:
```bash
sudo ss -tlnp | grep 7860
# åº”è¯¥æ˜¾ç¤º: 0.0.0.0:7860
```

### ç¬¬å››æ­¥ï¼šé…ç½®é˜²ç«å¢™

```bash
# å¼€æ”¾ç«¯å£
sudo ufw allow 7860/tcp comment "MeLo TTS"
sudo ufw allow 11434/tcp comment "Ollama"

# æŸ¥çœ‹çŠ¶æ€
sudo ufw status
```

### ç¬¬äº”æ­¥ï¼šé…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘

1. **ç™»å½•è·¯ç”±å™¨**: http://192.168.0.1
2. **åˆ‡æ¢è¯­è¨€**: æ‰¾åˆ°è¯­è¨€è®¾ç½®ï¼Œæ”¹ä¸ºä¸­æ–‡æˆ–è‹±æ–‡
3. **æ‰¾åˆ°ç«¯å£è½¬å‘è®¾ç½®**:
   - ä¸­æ–‡: é«˜çº§è®¾ç½® â†’ ç«¯å£è½¬å‘ / è™šæ‹ŸæœåŠ¡å™¨
   - è‹±æ–‡: Advanced â†’ Port Forwarding / Virtual Server

4. **æ·»åŠ è½¬å‘è§„åˆ™**:

   **è§„åˆ™ 1 - MeLo TTS**:
   ```
   Rule Name: Melo-TTS
   Internal IP: 192.168.0.13
   Protocol: TCP
   External Port: 7860~7860
   Internal Port: 7860~7860
   ```

   **è§„åˆ™ 2 - Ollama**:
   ```
   Rule Name: Ollama
   Internal IP: 192.168.0.13
   Protocol: TCP
   External Port: 11434~11434
   Internal Port: 11434~11434
   ```

5. **ä¿å­˜å¹¶åº”ç”¨é…ç½®**

### ç¬¬å…­æ­¥ï¼šä¿®æ”¹åº”ç”¨é…ç½®

æ›´æ–°æ¸¸æˆåº”ç”¨ä½¿ç”¨å…¬ç½‘IPï¼š

**1. ä¿®æ”¹ `src/App.tsx`** (ç¬¬98è¡Œ):
```typescript
config.meloConfig = {
  baseUrl: 'http://115.93.10.51:7860',  // æ”¹ä¸ºå…¬ç½‘IP
  timeout: 30000,
  retryCount: 2,
  defaultSpeaker: 'ZH',
};
```

**2. ä¿®æ”¹ `src/config/chatConfig.ts`** (ç¬¬89è¡Œ):
```typescript
export const DEFAULT_LLM_CHAT_CONFIG: LLMChatConfig = {
  provider: 'custom',
  apiUrl: 'http://115.93.10.51:11434/api/chat', // æ”¹ä¸ºå…¬ç½‘IP
  model: 'qwen2.5:3b',
  // ...å…¶ä»–é…ç½®
};
```

### ç¬¬ä¸ƒæ­¥ï¼šæµ‹è¯•è®¿é—®

**ä»æœåŠ¡å™¨æœ¬åœ°æµ‹è¯•**:
```bash
# æµ‹è¯• MeLo TTS
curl http://localhost:7860/health

# æµ‹è¯• Ollama
curl http://localhost:11434/api/tags
```

**ä»å†…ç½‘å…¶ä»–è®¾å¤‡æµ‹è¯•**:
```bash
curl http://192.168.0.13:7860/health
curl http://192.168.0.13:11434/api/tags
```

**ä»å¤–ç½‘æµ‹è¯•**:
```bash
# æµ‹è¯• MeLo TTS
curl http://115.93.10.51:7860/health

# æµ‹è¯• Ollama
curl http://115.93.10.51:11434/api/tags

# æµ‹è¯• TTS åŠŸèƒ½
curl -X POST http://115.93.10.51:7860/tts \
  -H "Content-Type: application/json" \
  -d '{"text": "å¤–ç½‘è®¿é—®æµ‹è¯•æˆåŠŸ", "lang": "ZH"}' \
  --output test.wav
```

---

## ğŸ› é—®é¢˜ä¿®å¤

### é—®é¢˜ï¼šcheckServer is not a function

**é”™è¯¯ä¿¡æ¯**:
```
Uncaught (in promise) TypeError: serverManager.checkServer is not a function
```

**åŸå› **: `OllamaServerManager` ç±»ä¸­ç¼ºå°‘ `checkServer` æ–¹æ³•ã€‚

**è§£å†³æ–¹æ¡ˆ**: åœ¨ `src/services/llm/OllamaServerManager.ts` ä¸­æ·»åŠ  `checkServer` æ–¹æ³•:

```typescript
/**
 * æ£€æŸ¥æœåŠ¡å™¨å¯ç”¨æ€§
 */
async checkServer(server: OllamaServerConfig): Promise<ServerCheckResult> {
  const startTime = Date.now();
  
  try {
    const url = this.getServerTagsUrl(server);
    const response = await fetch(url, {
      method: 'GET',
      headers: { 'Content-Type': 'application/json' },
      signal: AbortSignal.timeout(5000) // 5ç§’è¶…æ—¶
    });

    if (!response.ok) {
      return {
        available: false,
        error: `HTTP ${response.status}: ${response.statusText}`
      };
    }

    const data = await response.json();
    const latency = Date.now() - startTime;
    
    const result: ServerCheckResult = {
      available: true,
      latency,
      modelCount: data.models?.length || 0
    };
    
    // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
    this.updateServerStatus(server.id, result);
    
    return result;
  } catch (error) {
    const result: ServerCheckResult = {
      available: false,
      error: error instanceof Error ? error.message : 'è¿æ¥å¤±è´¥'
    };
    
    // æ›´æ–°æœåŠ¡å™¨çŠ¶æ€
    this.updateServerStatus(server.id, result);
    
    return result;
  }
}
```

**ä¿®å¤å**: åº”ç”¨å¯ä»¥æ­£å¸¸æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€å¹¶æ·»åŠ æ–°æœåŠ¡å™¨ã€‚

---

## âœ… é…ç½®éªŒè¯

### æœåŠ¡çŠ¶æ€æ£€æŸ¥

```bash
# æ£€æŸ¥ Ollama
sudo systemctl status ollama
curl http://115.93.10.51:11434/api/tags

# æ£€æŸ¥ MeLo TTS
ps aux | grep melo
curl http://115.93.10.51:7860/health
```

### æœŸæœ›è¾“å‡º

**MeLo TTS å¥åº·æ£€æŸ¥**:
```json
{
  "status": "ok",
  "service": "Melo TTS Multi",
  "supported_languages": ["ZH", "EN", "JP", "ES", "FR", "KR"]
}
```

**Ollama æ¨¡å‹åˆ—è¡¨**:
```json
{
  "models": [
    {"name": "qwen2:0.5b", ...},
    {"name": "qwen2.5:3b", ...},
    ...
  ]
}
```

---

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

| æµ‹è¯•é¡¹ | ç»“æœ |
|--------|------|
| **MeLo TTS å“åº”æ—¶é—´** | < 100ms |
| **Ollama å“åº”æ—¶é—´** | < 200ms |
| **TTS è¯­éŸ³åˆæˆ** | 1-3ç§’ |
| **AI å¯¹è¯ç”Ÿæˆ** | 2-5ç§’ |

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. è®¿é—®æ§åˆ¶

å¦‚æœéœ€è¦é™åˆ¶è®¿é—®ï¼Œå¯ä»¥åœ¨é˜²ç«å¢™ä¸­æ·»åŠ IPç™½åå•ï¼š

```bash
# åˆ é™¤å…¨å±€å…è®¸
sudo ufw delete allow 7860/tcp
sudo ufw delete allow 11434/tcp

# åªå…è®¸ç‰¹å®šIP
sudo ufw allow from ä½ çš„åŠå…¬å®¤IP to any port 7860 proto tcp
sudo ufw allow from ä½ çš„åŠå…¬å®¤IP to any port 11434 proto tcp
```

### 2. ä½¿ç”¨ HTTPS

å¦‚æœæœ‰åŸŸåï¼Œå»ºè®®é…ç½® HTTPSï¼ˆå‚è€ƒï¼š`dblife.comåŸŸåé…ç½®æ–¹æ¡ˆ.md`ï¼‰

### 3. API è®¤è¯

å¯ä»¥åœ¨ MeLo TTS æœåŠ¡ä¸­æ·»åŠ  API Key è®¤è¯ï¼ˆå‚è€ƒç›¸å…³æ–‡æ¡£ï¼‰

### 4. ç›‘æ§æ—¥å¿—

å®šæœŸæŸ¥çœ‹è®¿é—®æ—¥å¿—ï¼š
```bash
# Ollama æ—¥å¿—
sudo journalctl -u ollama -f

# MeLo TTS æ—¥å¿—
screen -r melo  # æŸ¥çœ‹å®æ—¶æ—¥å¿—
```

---

## ğŸ”§ æœåŠ¡ç®¡ç†

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨ Ollama
sudo systemctl start ollama

# MeLo TTS å·²åœ¨ screen ä¸­è¿è¡Œ
# å¦‚éœ€é‡å¯ï¼Œå…ˆåœæ­¢
screen -r melo
# æŒ‰ Ctrl+C åœæ­¢
# ç„¶åé‡æ–°è¿è¡Œå¯åŠ¨å‘½ä»¤
```

### åœæ­¢æœåŠ¡

```bash
# åœæ­¢ Ollama
sudo systemctl stop ollama

# åœæ­¢ MeLo TTS
pkill -f "python3 melo-multilang.py"
```

### æŸ¥çœ‹çŠ¶æ€

```bash
# Ollama çŠ¶æ€
sudo systemctl status ollama

# MeLo TTS çŠ¶æ€
screen -ls
ps aux | grep melo
```

---

## ğŸ“± å®¢æˆ·ç«¯ä½¿ç”¨

### æµè§ˆå™¨è®¿é—®

- **MeLo TTS API æ–‡æ¡£**: http://115.93.10.51:7860/docs
- **å¥åº·æ£€æŸ¥**: http://115.93.10.51:7860/health

### åº”ç”¨é…ç½®

æ¸¸æˆåº”ç”¨å·²é…ç½®ä½¿ç”¨å¤–ç½‘åœ°å€ï¼š
- TTS æœåŠ¡: `http://115.93.10.51:7860`
- Ollama æœåŠ¡: `http://115.93.10.51:11434`

### å‘½ä»¤è¡Œä½¿ç”¨

```bash
# TTS è¯­éŸ³åˆæˆ
curl -X POST http://115.93.10.51:7860/tts \
  -H "Content-Type: application/json" \
  -d '{"text": "ä½ å¥½ä¸–ç•Œ", "lang": "ZH"}' \
  --output speech.wav

# Ollama å¯¹è¯
curl -X POST http://115.93.10.51:11434/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "model": "qwen2.5:3b",
    "messages": [{"role": "user", "content": "ä½ å¥½"}],
    "stream": false
  }'
```

---

## ğŸ‰ é…ç½®å®Œæˆæ£€æŸ¥æ¸…å•

- [x] æŸ¥çœ‹å…¬ç½‘IP: 115.93.10.51
- [x] é…ç½® Ollama ç›‘å¬ 0.0.0.0:11434
- [x] é…ç½® MeLo TTS ç›‘å¬ 0.0.0.0:7860
- [x] é…ç½®é˜²ç«å¢™å¼€æ”¾ç«¯å£
- [x] é…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘
- [x] ä¿®æ”¹åº”ç”¨é…ç½®æ–‡ä»¶
- [x] ä¿®å¤ checkServer æ–¹æ³•ç¼ºå¤±é—®é¢˜
- [x] æµ‹è¯•æœ¬åœ°è®¿é—®
- [x] æµ‹è¯•å†…ç½‘è®¿é—®
- [x] æµ‹è¯•å¤–ç½‘è®¿é—®
- [x] éªŒè¯åº”ç”¨åŠŸèƒ½

---

## ğŸ“ æ•…éšœæ’æŸ¥

### æ— æ³•ä»å¤–ç½‘è®¿é—®

**æ£€æŸ¥æ¸…å•**:
1. æœåŠ¡æ˜¯å¦è¿è¡Œï¼Ÿ`curl http://localhost:7860/health`
2. é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ï¼Ÿ`sudo ufw status`
3. è·¯ç”±å™¨ç«¯å£è½¬å‘æ˜¯å¦é…ç½®ï¼Ÿç™»å½•è·¯ç”±å™¨æŸ¥çœ‹
4. å…¬ç½‘IPæ˜¯å¦æ­£ç¡®ï¼Ÿ`curl ifconfig.me`
5. æ˜¯å¦æœ‰å¤šå±‚è·¯ç”±å™¨ï¼Ÿéœ€è¦æ¯å±‚éƒ½é…ç½®ç«¯å£è½¬å‘

### æœåŠ¡è¿è¡Œä½†æ— å“åº”

```bash
# æ£€æŸ¥ç«¯å£ç›‘å¬
sudo ss -tlnp | grep -E "7860|11434"

# æ£€æŸ¥è¿›ç¨‹
ps aux | grep -E "ollama|melo"

# é‡å¯æœåŠ¡
sudo systemctl restart ollama
```

### åº”ç”¨è¿æ¥å¤±è´¥

1. æ£€æŸ¥åº”ç”¨é…ç½®ä¸­çš„IPæ˜¯å¦æ­£ç¡®
2. åœ¨æµè§ˆå™¨ä¸­ç›´æ¥è®¿é—®æµ‹è¯•ï¼šhttp://115.93.10.51:7860/health
3. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯ä¿¡æ¯
4. ç¡®è®¤é˜²ç«å¢™/ä»£ç†è®¾ç½®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [MeLo TTS é…ç½®æŒ‡å—](./MeLo-TTSå®Œæ•´é…ç½®æŒ‡å—.md)
- [Ollama æœåŠ¡é…ç½®](./start-ollama.md)
- [åŸŸåé…ç½®æ–¹æ¡ˆ](../dblife.comåŸŸåé…ç½®æ–¹æ¡ˆ.md)
- [å¿«é€Ÿå¯åŠ¨æŒ‡å—](../../QUICK-START.md)

---

## ğŸ“ æ›´æ–°æ—¥å¿—

### 2025-12-04
- âœ… åˆå§‹é…ç½®å®Œæˆ
- âœ… é…ç½®å…¬ç½‘IPè®¿é—®ï¼š115.93.10.51
- âœ… é…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘
- âœ… ä¿®å¤ checkServer æ–¹æ³•ç¼ºå¤±é—®é¢˜
- âœ… æµ‹è¯•éªŒè¯é€šè¿‡

---

**é…ç½®çŠ¶æ€**: âœ… å·²å®Œæˆ  
**æœ€åæµ‹è¯•**: 2025-12-04  
**ç»´æŠ¤äººå‘˜**: hlsystem


