# TTS 配置系统使用指南

## 📖 概述

全新的TTS配置系统支持多服务器管理、场景化配置和自动回退，让您可以灵活配置语音合成服务。

## 🚀 快速开始

### 1. 打开TTS配置

在游戏配置面板中，找到 **"🔊 TTS 语音配置"** 卡片，点击进入配置界面。

### 2. 添加TTS服务器

点击 **"➕ 添加服务器"** 按钮，选择服务器类型：

- **Piper TTS**: 轻量级本地TTS，质量好、速度快
- **Azure Speech**: 微软云端TTS，质量最高但需要API Key
- **浏览器 TTS**: 使用浏览器内置的语音合成

### 3. 配置连接方式

根据服务器位置选择连接方式：

#### 本地服务器
- 点击 **"本地"** 标签
- 系统自动使用 `localhost` 地址
- Piper 默认端口：5000

#### 局域网服务器
- 点击 **"局域网"** 标签
- 输入IP地址最后两段（如：`0.13` 自动补全为 `192.168.0.13`）
- 输入端口号（默认 5000）

#### 自定义服务器
- 点击 **"自定义"** 标签
- 输入完整的主机地址（IP或域名）
- 输入端口号

### 4. 测试服务器

添加服务器后：
1. 点击 **🔍** 按钮测试连接
2. 系统会自动检查服务器健康状态
3. 显示连接延迟（毫秒）

### 5. 启用/禁用服务器

- 使用开关按钮启用或禁用服务器
- ⭐ **重要**: 禁用的服务器不会被健康检查轮询，节省资源

## 🎯 核心功能

### 多服务器管理

#### 服务器优先级
- 系统按优先级自动选择TTS服务器
- 数字越小优先级越高（1 > 2 > 3）
- 可以通过修改 `priority` 字段调整优先级

#### 自动回退机制
当首选服务器不可用时：
1. 自动尝试次优先级服务器
2. 依次尝试所有已启用的服务器
3. 最后回退到浏览器TTS（如果启用）

#### 健康检查
- 系统每5分钟自动检查已启用服务器的健康状态
- **禁用的服务器不会被检查**（节省资源）
- 显示服务器状态：
  - ✅ 可用
  - ❌ 不可用
  - 🔄 检查中
  - ⚪ 已禁用

### 服务器状态指示

| 图标 | 含义 |
|------|------|
| ✅ | 服务器可用，连接正常 |
| ❌ | 服务器不可用或连接失败 |
| 🔄 | 正在检查服务器状态 |
| ⚪ | 服务器已被禁用 |
| ❓ | 状态未知（尚未检查） |

## 📝 配置示例

### 示例 1: 本地 Piper TTS

```
名称: 本地 Piper TTS
类型: Piper
连接: localhost:5000
状态: ✅ 可用 (15ms)
优先级: 1
```

### 示例 2: 局域网 Piper TTS

```
名称: 办公室 Piper 服务器
类型: Piper
连接: 192.168.0.13:5000
状态: ✅ 可用 (28ms)
优先级: 2
```

### 示例 3: Azure Speech TTS

```
名称: Azure Speech TTS
类型: Azure
连接: https://api.cognitive.microsoft.com
状态: ✅ 可用 (120ms)
优先级: 0 (最高优先级)
配置: 
  - 订阅密钥: ****
  - 区域: eastus
  - 语音: zh-CN-XiaoxiaoNeural
```

## 🎨 场景化配置（即将推出）

未来版本将支持为不同场景配置不同的TTS：

- **系统音效**: 过、要不起、出牌提示等
- **聊天语音**: AI玩家的对话
- **报牌语音**: 大小王、同花顺等牌型播报
- **AI对话音**: 想法生成、策略分析等

## 💡 使用技巧

### 1. 优先级策略

**推荐配置**:
```
优先级 0: Azure Speech TTS (最高质量，但较慢)
优先级 1: 局域网 Piper TTS (快速，质量好)
优先级 2: 本地 Piper TTS (备用)
优先级 3: 浏览器 TTS (最后的后备)
```

### 2. 性能优化

- **禁用不用的服务器**: 避免不必要的健康检查
- **选择低延迟服务器**: 优先使用局域网或本地服务器
- **配置合理的超时时间**: 避免等待时间过长

### 3. 故障排查

#### 服务器连接失败

1. **检查网络连接**
   - 确保服务器正在运行
   - 检查防火墙设置
   - 确认IP地址和端口正确

2. **检查服务器日志**
   - Piper: `/tmp/piper-tts.log`
   - 查看错误信息

3. **测试连接**
   - 使用 🔍 按钮测试连接
   - 查看错误提示

#### 语音合成失败

1. **检查服务器状态**: 确保服务器显示为 ✅ 可用
2. **尝试其他服务器**: 切换到备用服务器
3. **查看浏览器控制台**: 查看详细错误信息

### 4. 配置持久化

- 所有配置自动保存到 `localStorage`
- 重启浏览器后自动恢复配置
- 可以导出/导入配置（功能开发中）

## 🔧 高级配置

### 全局设置

可通过代码配置全局设置（未来会添加UI）：

```typescript
{
  healthCheck: {
    enabled: true,              // 启用健康检查
    interval: 5 * 60 * 1000,   // 检查间隔：5分钟
    timeout: 5000,              // 超时时间：5秒
    retryCount: 2,              // 重试次数
    exponentialBackoff: true    // 指数退避
  },
  fallback: {
    autoFallback: true,         // 自动回退
    fallbackDelay: 100,         // 回退延迟：100ms
    maxRetries: 3               // 最大重试次数
  },
  cache: {
    enabled: true,              // 启用缓存
    maxSize: 50,                // 最大缓存：50MB
    ttl: 24 * 60 * 60 * 1000   // 缓存过期：24小时
  }
}
```

### 提供者特定配置

#### Piper TTS
```typescript
{
  model: 'zh_CN-huayan-medium',  // 模型名称
  speakerId: 0                    // 说话人ID（可选）
}
```

#### Azure Speech TTS
```typescript
{
  subscriptionKey: 'YOUR_KEY',           // 订阅密钥
  region: 'eastus',                      // 区域
  voiceName: 'zh-CN-XiaoxiaoNeural',    // 语音名称
  voiceStyle: 'cheerful',                // 语音风格（可选）
  rate: 0,                               // 语速调整（-50 to 50）
  pitch: 0                               // 音调调整（-50 to 50）
}
```

#### 浏览器 TTS
```typescript
{
  voice: undefined,      // 语音名称（自动选择）
  rate: 1.0,            // 语速（0.1 - 10）
  pitch: 1.0,           // 音调（0 - 2）
  volume: 1.0           // 音量（0 - 1）
}
```

## 📊 监控与统计

配置面板底部显示实时统计：

- **总计**: 所有配置的服务器数量
- **已启用**: 当前启用的服务器数量
- **可用**: 健康状态为可用的服务器数量

## 🆘 常见问题

### Q: 为什么服务器显示 ❌ 不可用？

**A**: 可能的原因：
1. 服务器未启动
2. 网络连接问题
3. IP地址或端口配置错误
4. 防火墙阻止连接

### Q: 如何提高语音合成速度？

**A**: 
1. 使用本地或局域网的Piper TTS
2. 禁用不用的服务器
3. 调整健康检查间隔

### Q: 配置会丢失吗？

**A**: 不会。所有配置自动保存到浏览器的 localStorage，除非您清除浏览器数据。

### Q: 可以同时使用多个服务器吗？

**A**: 可以。系统会按优先级自动选择，并在首选服务器不可用时自动回退。

### Q: 禁用服务器后还会被检查吗？

**A**: 不会。这是新系统的核心改进之一，禁用的服务器不会被健康检查轮询。

## 🔗 相关文档

- [TTS 配置系统设计文档](../design/tts-config-refactor.md)
- [TTS 配置系统实施计划](../design/tts-refactor-implementation-plan.md)
- [Piper TTS 安装指南](../setup/piper-tts-setup.md)
- [Azure Speech TTS 配置](../setup/azure-speech-setup.md)

## 📞 获取帮助

遇到问题？

1. 查看浏览器控制台的错误信息
2. 检查服务器日志文件
3. 参考故障排查章节
4. 提交 Issue 报告问题

---

**提示**: 建议至少配置一个本地 Piper TTS 和浏览器 TTS 作为后备，确保语音功能始终可用。

