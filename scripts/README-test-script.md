# 测试脚本使用说明

## 运行测试并记录错误日志

### 基本用法

在 WSL 环境下运行：

```bash
./scripts/run-tests-with-error-logging.sh
```

或者：

```bash
bash scripts/run-tests-with-error-logging.sh
```

### 脚本功能

该脚本会：

1. **运行所有测试**：使用 `npm run test:realtime` 运行完整测试套件
2. **实时显示进度**：在控制台实时显示测试进度
3. **记录详细日志**：
   - `test-logs/test-run-YYYYMMDD-HHMMSS.log` - 完整的测试运行日志
   - `test-logs/test-errors-YYYYMMDD-HHMMSS.log` - 仅包含失败测试的详细错误信息
   - `test-logs/test-summary-YYYYMMDD-HHMMSS.txt` - 测试运行摘要
   - `test-logs/test-results-YYYYMMDD-HHMMSS.json` - JSON 格式的测试结果（如果可用）

4. **提取错误信息**：
   - 自动识别所有失败的测试用例
   - 提取每个失败测试的完整错误堆栈
   - 记录错误类型、位置和详细信息

### 输出文件说明

#### 1. 完整日志 (`test-run-*.log`)
包含所有测试运行的完整输出，包括：
- 所有测试用例的执行结果
- 通过和失败的详细信息
- 测试统计信息

#### 2. 错误日志 (`test-errors-*.log`)
仅包含失败的测试用例，每个失败测试包括：
- 测试名称和位置
- 完整的错误堆栈跟踪
- 错误类型和消息
- 相关代码位置

#### 3. 摘要文件 (`test-summary-*.txt`)
包含：
- 测试运行时间
- 总测试数、通过数、失败数、跳过数
- 总耗时
- 失败测试列表
- 日志文件路径

### 查看错误日志

查看最新的错误日志：

```bash
# 查看最新的错误日志
cat test-logs/test-errors-*.log | tail -n 100

# 或者查看最新的摘要
cat test-logs/test-summary-*.txt

# 查看所有失败的测试名称
grep "失败测试:" test-logs/test-errors-*.log
```

### 示例输出

运行脚本后，你会看到类似以下的输出：

```
[2025-11-30 23:05:40] [INFO] ==========================================
[2025-11-30 23:05:40] [INFO] 开始运行测试套件（带详细错误记录）
[2025-11-30 23:05:40] [INFO] ==========================================
[2025-11-30 23:05:40] [INFO] 日志文件: ./test-logs/test-run-20251130-230540.log
[2025-11-30 23:05:40] [INFO] 错误日志: ./test-logs/test-errors-20251130-230540.log
...

[2025-11-30 23:25:57] [INFO] ==========================================
[2025-11-30 23:25:57] [INFO] 测试运行完成
[2025-11-30 23:25:57] [INFO] ==========================================
[2025-11-30 23:25:57] [INFO] 总测试数: 234
[2025-11-30 23:25:57] [INFO] 通过: 230
[2025-11-30 23:25:57] [INFO] 失败: 4
[2025-11-30 23:25:57] [INFO] 跳过: 0
[2025-11-30 23:25:57] [INFO] 总耗时: 1217秒
```

### 故障排除

如果脚本无法正常运行：

1. **确保有执行权限**：
   ```bash
   chmod +x scripts/run-tests-with-error-logging.sh
   ```

2. **检查 Node.js 和 npm**：
   ```bash
   node --version
   npm --version
   ```

3. **检查测试命令**：
   ```bash
   npm run test:realtime
   ```

4. **如果 JSON 解析失败**（可选）：
   脚本会尝试使用 `jq` 解析 JSON 输出，如果未安装 `jq`，会跳过 JSON 解析但不影响其他功能。

### 注意事项

- 脚本会运行完整的测试套件，可能需要较长时间
- 所有日志文件保存在 `test-logs/` 目录下
- 如果测试失败，脚本会以退出码 1 退出
- 所有测试通过时，脚本会以退出码 0 退出

