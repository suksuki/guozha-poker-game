# Vue Mobile 自动化测试套件

## 测试结构

```
tests/
├── unit/              # 单元测试
│   ├── channelScheduler.test.ts
│   ├── ttsService.test.ts
│   ├── gameStore-*.test.ts
│   └── ...
├── integration/       # 集成测试
│   ├── comprehensive.test.ts          # 全面测试套件
│   ├── tts-channel-allocation.test.ts # TTS声道分配测试
│   ├── card-announcement-sync.test.ts # 报牌同步测试
│   ├── game-flow-integration.test.ts
│   └── ...
└── setup.ts          # 测试设置
```

## 测试覆盖范围

### 1. 游戏核心功能 ✅
- 游戏初始化
- 开始游戏
- 出牌
- 不要
- 自动出牌（托管模式）

### 2. TTS语音播报系统 ✅
- TTS服务初始化
- **报牌使用ANNOUNCEMENT声道（独占）**
- **聊天使用玩家声道（PLAYER_0-PLAYER_7）**
- **报牌和聊天并发播放（不同声道）**
- **系统聊天消息也使用玩家声道（不是ANNOUNCEMENT）**

### 3. 多声道音频系统 ✅
- 多声道音频服务初始化
- 最大并发玩家数配置
- **报牌独占ANNOUNCEMENT声道**
- **聊天使用玩家声道，动态分配**

### 4. 设置管理 ✅
- 游戏设置保存/加载
- 语音播报设置
- TTS服务器配置管理

### 5. AI Brain集成 ✅
- AI Brain初始化
- 状态通知

### 6. 聊天系统 ✅
- 添加聊天消息
- 获取玩家最新消息

### 7. 完整游戏流程 ✅
- 开始 -> 出牌 -> 报牌 -> 聊天 -> 结束

### 8. 错误处理和边界情况 ✅
- 空手牌出牌
- 无效卡牌出牌
- TTS服务不可用
- **报牌失败时继续游戏流程**
- **报牌超时后继续游戏流程**

### 9. 报牌同步机制 ✅
- **报牌完成后触发下一个玩家（onAudioGenerated回调）**
- **报牌失败时继续游戏流程**
- **报牌超时后继续游戏流程**

### 10. 性能测试 ✅
- 多个出牌操作性能
- 大量聊天消息处理

### 11. 并发测试 ✅
- 多个玩家同时聊天
- **报牌和聊天同时播放（不同声道）**

## 运行测试

```bash
# 运行所有测试
npm test

# 运行所有测试（单次）
npm test -- --run

# 运行特定测试文件
npm test -- comprehensive.test.ts

# 运行单元测试
npm test -- tests/unit

# 运行集成测试
npm test -- tests/integration

# 查看覆盖率
npm test -- --coverage
```

## 测试统计

- **单元测试**: 29个测试文件
- **集成测试**: 9个测试文件
- **总计**: 38个测试文件

## 关键测试场景

### TTS声道分配（2024-12-19改进）
- ✅ **报牌使用 `ANNOUNCEMENT` 声道（独占，优先级4）**
- ✅ **聊天使用 `PLAYER_0` 到 `PLAYER_7` 声道（共享，根据玩家ID分配）**
- ✅ **系统聊天消息也使用玩家声道（不是ANNOUNCEMENT）**
- ✅ **报牌和聊天可以同时播放（不同声道，互不干扰）**

### 报牌同步机制（2024-12-19改进）
- ✅ **报牌完成后触发下一个玩家（通过onAudioGenerated回调）**
- ✅ **onAudioGenerated在音频完全播放完成后触发（onEnd回调中）**
- ✅ **报牌失败时继续游戏流程（错误处理）**
- ✅ **报牌超时后继续游戏流程（超时处理）**

### 报牌同步
- ✅ 报牌完成后触发下一个玩家
- ✅ 报牌失败时继续游戏流程
- ✅ 报牌超时后继续游戏流程

### 游戏流程
- ✅ 完整游戏流程测试
- ✅ 错误处理测试
- ✅ 性能测试

## 注意事项

1. 某些测试需要mock外部服务（如TTS服务器、AI Brain）
2. 性能测试可能需要调整超时时间
3. 集成测试可能需要更长的执行时间

## 持续改进

- [ ] 添加E2E测试（使用Playwright或Cypress）
- [ ] 增加测试覆盖率报告
- [ ] 添加性能基准测试
- [ ] 添加可视化回归测试

