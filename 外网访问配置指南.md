# ðŸŒ å¤–ç½‘è®¿é—® 0.13 æœåŠ¡å™¨çš„ MeLo TTS å’Œ Ollama é…ç½®æŒ‡å—

## ðŸ“‹ å½“å‰æœåŠ¡çŠ¶æ€

ä½ åœ¨ **192.168.0.13** æœåŠ¡å™¨ä¸Šè¿è¡Œäº†ä»¥ä¸‹æœåŠ¡ï¼š

| æœåŠ¡ | ç«¯å£ | å†…ç½‘è®¿é—®åœ°å€ | ç»‘å®šåœ°å€ |
|------|------|------------|---------|
| MeLo TTS | 7860 | http://192.168.0.13:7860 | 0.0.0.0 âœ… |
| Ollama | 11434 | http://192.168.0.13:11434 | localhost âš ï¸ |

## ðŸŽ¯ å¤–ç½‘è®¿é—®æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šå†…ç½‘ç©¿é€ï¼ˆæŽ¨èï¼Œæœ€ç®€å•ï¼‰

ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·å¯ä»¥è®©å¤–ç½‘ç›´æŽ¥è®¿é—®å†…ç½‘æœåŠ¡ï¼Œæ— éœ€å…¬ç½‘ IP æˆ–è·¯ç”±å™¨é…ç½®ã€‚

#### 1. ä½¿ç”¨ frpï¼ˆå…è´¹ï¼ŒæŽ¨èï¼‰

**åœ¨ 0.13 æœåŠ¡å™¨ä¸Šå®‰è£… frp å®¢æˆ·ç«¯ï¼š**

```bash
# ä¸‹è½½ frp
cd ~
wget https://github.com/fatedier/frp/releases/download/v0.52.3/frp_0.52.3_linux_amd64.tar.gz
tar -xzf frp_0.52.3_linux_amd64.tar.gz
cd frp_0.52.3_linux_amd64

# åˆ›å»ºé…ç½®æ–‡ä»¶
cat > frpc.ini << 'EOF'
[common]
server_addr = frpæœåŠ¡å™¨åœ°å€
server_port = 7000
token = your_token

[melotts]
type = tcp
local_ip = 127.0.0.1
local_port = 7860
remote_port = 17860

[ollama]
type = tcp
local_ip = 127.0.0.1
local_port = 11434
remote_port = 11434
EOF

# å¯åŠ¨ frp å®¢æˆ·ç«¯
./frpc -c frpc.ini
```

**å¤–ç½‘è®¿é—®åœ°å€ï¼š**
- MeLo TTS: `http://frpæœåŠ¡å™¨IP:17860`
- Ollama: `http://frpæœåŠ¡å™¨IP:11434`

#### 2. ä½¿ç”¨ ngrokï¼ˆç®€å•ä½†éœ€è¦æ³¨å†Œï¼‰

```bash
# å®‰è£… ngrok
curl -s https://ngrok-agent.s3.amazonaws.com/ngrok.asc | \
  sudo tee /etc/apt/trusted.gpg.d/ngrok.asc >/dev/null && \
  echo "deb https://ngrok-agent.s3.amazonaws.com buster main" | \
  sudo tee /etc/apt/sources.list.d/ngrok.list && \
  sudo apt update && sudo apt install ngrok

# è®¤è¯ï¼ˆéœ€è¦åœ¨ ngrok.com æ³¨å†ŒèŽ·å– tokenï¼‰
ngrok config add-authtoken YOUR_TOKEN

# åŒæ—¶æš´éœ²ä¸¤ä¸ªç«¯å£
ngrok http 7860 &
ngrok http 11434 &
```

#### 3. ä½¿ç”¨ CloudFlare Tunnelï¼ˆå…è´¹ï¼Œä¸“ä¸šï¼‰

```bash
# å®‰è£… cloudflared
wget https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
chmod +x cloudflared-linux-amd64
sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

# ç™»å½• CloudFlare
cloudflared tunnel login

# åˆ›å»ºéš§é“
cloudflared tunnel create poker-services

# é…ç½®éš§é“
cat > ~/.cloudflared/config.yml << 'EOF'
url: http://localhost:7860
tunnel: <tunnel-id>
credentials-file: /home/your-user/.cloudflared/<tunnel-id>.json
ingress:
  - hostname: melotts.your-domain.com
    service: http://localhost:7860
  - hostname: ollama.your-domain.com
    service: http://localhost:11434
  - service: http_status:404
EOF

# è¿è¡Œéš§é“
cloudflared tunnel run poker-services
```

---

### æ–¹æ¡ˆäºŒï¼šè·¯ç”±å™¨ç«¯å£è½¬å‘ï¼ˆéœ€è¦å…¬ç½‘ IPï¼‰

å¦‚æžœä½ æœ‰å…¬ç½‘ IP æˆ–è€…èƒ½è®¿é—®è·¯ç”±å™¨ç®¡ç†ç•Œé¢ï¼š

#### æ­¥éª¤ 1ï¼šé…ç½®è·¯ç”±å™¨ç«¯å£è½¬å‘

ç™»å½•è·¯ç”±å™¨ç®¡ç†ç•Œé¢ï¼ˆé€šå¸¸æ˜¯ 192.168.0.1 æˆ– 192.168.1.1ï¼‰ï¼Œæ‰¾åˆ°"ç«¯å£è½¬å‘"æˆ–"è™šæ‹ŸæœåŠ¡å™¨"è®¾ç½®ï¼š

| æœåŠ¡å | å¤–éƒ¨ç«¯å£ | å†…éƒ¨ IP | å†…éƒ¨ç«¯å£ | åè®® |
|--------|----------|---------|----------|------|
| MeLo-TTS | 7860 | 192.168.0.13 | 7860 | TCP |
| Ollama | 11434 | 192.168.0.13 | 11434 | TCP |

#### æ­¥éª¤ 2ï¼šç¡®ä¿ Ollama ç»‘å®šåˆ° 0.0.0.0

Ollama é»˜è®¤åªç›‘å¬ localhostï¼Œéœ€è¦ä¿®æ”¹ï¼š

```bash
# åœ¨ 0.13 æœåŠ¡å™¨ä¸Š
# åœæ­¢å½“å‰çš„ Ollama æœåŠ¡
pkill ollama

# è®¾ç½®çŽ¯å¢ƒå˜é‡å¹¶å¯åŠ¨
export OLLAMA_HOST=0.0.0.0:11434
ollama serve &

# æˆ–è€…åˆ›å»ºç³»ç»ŸæœåŠ¡
sudo tee /etc/systemd/system/ollama.service > /dev/null << 'EOF'
[Unit]
Description=Ollama LLM Service
After=network.target

[Service]
Type=simple
User=YOUR_USERNAME
Environment="OLLAMA_HOST=0.0.0.0:11434"
ExecStart=/usr/local/bin/ollama serve
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# å¯åŠ¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable ollama
sudo systemctl start ollama
```

#### æ­¥éª¤ 3ï¼šé…ç½®é˜²ç«å¢™

```bash
# Ubuntu/Debian
sudo ufw allow 7860/tcp comment "MeLo TTS"
sudo ufw allow 11434/tcp comment "Ollama"
sudo ufw reload

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=7860/tcp
sudo firewall-cmd --permanent --add-port=11434/tcp
sudo firewall-cmd --reload
```

#### æ­¥éª¤ 4ï¼šèŽ·å–å…¬ç½‘ IP

```bash
# æŸ¥çœ‹å…¬ç½‘ IP
curl ifconfig.me
# æˆ–
curl ipinfo.io/ip
```

**å¤–ç½‘è®¿é—®åœ°å€ï¼š**
- MeLo TTS: `http://ä½ çš„å…¬ç½‘IP:7860`
- Ollama: `http://ä½ çš„å…¬ç½‘IP:11434`

---

### æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨ VPNï¼ˆæœ€å®‰å…¨ï¼‰

å¦‚æžœæ˜¯å›¢é˜Ÿå†…éƒ¨ä½¿ç”¨ï¼Œå»ºè®®æ­å»º VPNï¼š

#### ä½¿ç”¨ WireGuardï¼ˆæŽ¨èï¼‰

**åœ¨ 0.13 æœåŠ¡å™¨ä¸Šå®‰è£… WireGuardï¼š**

```bash
# å®‰è£…
sudo apt update
sudo apt install wireguard

# ç”Ÿæˆå¯†é’¥
wg genkey | tee privatekey | wg pubkey > publickey

# é…ç½®æœåŠ¡å™¨
sudo tee /etc/wireguard/wg0.conf > /dev/null << 'EOF'
[Interface]
PrivateKey = æœåŠ¡å™¨ç§é’¥
Address = 10.0.0.1/24
ListenPort = 51820
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT

[Peer]
PublicKey = å®¢æˆ·ç«¯å…¬é’¥
AllowedIPs = 10.0.0.2/32
EOF

# å¯åŠ¨ WireGuard
sudo wg-quick up wg0
sudo systemctl enable wg-quick@wg0
```

**åœ¨å®¢æˆ·ç«¯é…ç½®ï¼š**

```ini
[Interface]
PrivateKey = å®¢æˆ·ç«¯ç§é’¥
Address = 10.0.0.2/24
DNS = 8.8.8.8

[Peer]
PublicKey = æœåŠ¡å™¨å…¬é’¥
Endpoint = æœåŠ¡å™¨å…¬ç½‘IP:51820
AllowedIPs = 192.168.0.0/24
PersistentKeepalive = 25
```

è¿žæŽ¥ VPN åŽï¼Œç›´æŽ¥ä½¿ç”¨å†…ç½‘åœ°å€ï¼š
- MeLo TTS: `http://192.168.0.13:7860`
- Ollama: `http://192.168.0.13:11434`

---

## ðŸ”’ å®‰å…¨å»ºè®®

### 1. æ·»åŠ è®¤è¯ï¼ˆæŽ¨èï¼‰

ä¿®æ”¹ MeLo TTS æœåŠ¡ï¼Œæ·»åŠ  API Key è®¤è¯ï¼š

```python
# åœ¨ start-melo-tts-server.py ä¸­æ·»åŠ 
from fastapi import Header, HTTPException

API_KEY = "your-secret-api-key"  # è®¾ç½®ä½ çš„å¯†é’¥

async def verify_api_key(x_api_key: str = Header()):
    if x_api_key != API_KEY:
        raise HTTPException(status_code=401, detail="æ— æ•ˆçš„ API Key")
    return x_api_key

# åœ¨è·¯ç”±ä¸­æ·»åŠ ä¾èµ–
@app.post("/tts", dependencies=[Depends(verify_api_key)])
async def synthesize_speech(request: TTSRequest):
    # ... åŽŸæœ‰ä»£ç 
```

### 2. ä½¿ç”¨åå‘ä»£ç†ï¼ˆNginxï¼‰

```bash
# å®‰è£… Nginx
sudo apt install nginx

# é…ç½®åå‘ä»£ç†
sudo tee /etc/nginx/sites-available/poker-services > /dev/null << 'EOF'
server {
    listen 80;
    server_name your-domain.com;

    # MeLo TTS
    location /tts/ {
        proxy_pass http://localhost:7860/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Ollama
    location /ollama/ {
        proxy_pass http://localhost:11434/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # é™åˆ¶è®¿é—®
    # allow ä½ çš„IPåœ°å€;
    # deny all;
}
EOF

# å¯ç”¨é…ç½®
sudo ln -s /etc/nginx/sites-available/poker-services /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

### 3. é…ç½® HTTPSï¼ˆä½¿ç”¨ Let's Encryptï¼‰

```bash
# å®‰è£… certbot
sudo apt install certbot python3-certbot-nginx

# èŽ·å–è¯ä¹¦
sudo certbot --nginx -d your-domain.com

# è‡ªåŠ¨ç»­æœŸ
sudo certbot renew --dry-run
```

---

## âœ… æµ‹è¯•å¤–ç½‘è®¿é—®

### 1. æµ‹è¯• MeLo TTS

```bash
# ä½¿ç”¨å¤–ç½‘åœ°å€æµ‹è¯•
curl -X POST http://ä½ çš„å¤–ç½‘åœ°å€:7860/tts \
  -H "Content-Type: application/json" \
  -d '{"text": "å¤–ç½‘æµ‹è¯•æˆåŠŸ", "lang": "ZH"}' \
  --output test-external.wav

# æ£€æŸ¥æ–‡ä»¶
ls -lh test-external.wav
```

### 2. æµ‹è¯• Ollama

```bash
# å¥åº·æ£€æŸ¥
curl http://ä½ çš„å¤–ç½‘åœ°å€:11434/api/tags

# æµ‹è¯•å¯¹è¯
curl -X POST http://ä½ çš„å¤–ç½‘åœ°å€:11434/api/chat \
  -H "Content-Type: application/json" \
  -d '{
    "model": "qwen2:0.5b",
    "messages": [
      {"role": "user", "content": "ä½ å¥½"}
    ],
    "stream": false
  }'
```

---

## ðŸ“Š ç›‘æŽ§å’Œç»´æŠ¤

### 1. è®¾ç½®åŽå°è¿è¡Œ

åˆ›å»ºå¯åŠ¨è„šæœ¬ï¼š

```bash
#!/bin/bash
# ~/start-all-services.sh

# å¯åŠ¨ MeLo TTS
cd ~/melotts/MeloTTS
nohup python3 start-melo-tts-server.py > logs/melotts.log 2>&1 &

# å¯åŠ¨ Ollama
export OLLAMA_HOST=0.0.0.0:11434
nohup ollama serve > logs/ollama.log 2>&1 &

echo "æ‰€æœ‰æœåŠ¡å·²å¯åŠ¨"
```

### 2. ä½¿ç”¨ systemd ç®¡ç†æœåŠ¡

**MeLo TTS æœåŠ¡ï¼š**

```bash
sudo tee /etc/systemd/system/melotts.service > /dev/null << 'EOF'
[Unit]
Description=MeLo TTS API Service
After=network.target

[Service]
Type=simple
User=YOUR_USERNAME
WorkingDirectory=/home/YOUR_USERNAME/melotts/MeloTTS
ExecStart=/usr/bin/python3 /home/YOUR_USERNAME/melotts/MeloTTS/start-melo-tts-server.py
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable melotts
sudo systemctl start melotts
```

### 3. ç›‘æŽ§æœåŠ¡çŠ¶æ€

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
sudo systemctl status melotts
sudo systemctl status ollama

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u melotts -f
sudo journalctl -u ollama -f

# æ£€æŸ¥ç«¯å£
ss -tlnp | grep -E '7860|11434'
```

---

## ðŸŽ‰ æŽ¨èæ–¹æ¡ˆæ€»ç»“

### é€‚åˆä¸ªäºº/ä¸´æ—¶ä½¿ç”¨ï¼š
âœ… **ngrok** - æœ€ç®€å•ï¼Œ5åˆ†é’Ÿæžå®š

### é€‚åˆé•¿æœŸä½¿ç”¨ï¼š
âœ… **frp + è‡ªå·±çš„æœåŠ¡å™¨** - ç¨³å®šå¯é 
âœ… **CloudFlare Tunnel** - å…è´¹ä¸”ä¸“ä¸š

### é€‚åˆå›¢é˜Ÿå†…éƒ¨ï¼š
âœ… **WireGuard VPN** - æœ€å®‰å…¨

### å¦‚æžœæœ‰å…¬ç½‘ IPï¼š
âœ… **è·¯ç”±å™¨ç«¯å£è½¬å‘ + Nginxåå‘ä»£ç†** - æœ€ç›´æŽ¥

---

## ðŸ“ é…ç½®å®¢æˆ·ç«¯åº”ç”¨

å¤–ç½‘è®¿é—®é…ç½®æˆåŠŸåŽï¼Œåœ¨ä½ çš„æ¸¸æˆåº”ç”¨ä¸­ä¿®æ”¹é…ç½®ï¼š

**ç¼–è¾‘ `src/App.tsx` æˆ–é…ç½®æ–‡ä»¶ï¼š**

```typescript
// ä½¿ç”¨å¤–ç½‘åœ°å€
const config = {
  meloTTS: {
    baseUrl: 'http://ä½ çš„å¤–ç½‘åœ°å€:7860'  // æˆ–ä½¿ç”¨åŸŸå
  },
  ollama: {
    baseUrl: 'http://ä½ çš„å¤–ç½‘åœ°å€:11434',
    model: 'qwen2:0.5b'
  }
};
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: ç«¯å£è½¬å‘é…ç½®åŽä»æ— æ³•è®¿é—®ï¼Ÿ

æ£€æŸ¥æ¸…å•ï¼š
1. âœ… æœåŠ¡æ˜¯å¦ç»‘å®šåˆ° 0.0.0.0ï¼Ÿ
2. âœ… é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ç«¯å£ï¼Ÿ
3. âœ… è·¯ç”±å™¨ç«¯å£è½¬å‘æ˜¯å¦æ­£ç¡®ï¼Ÿ
4. âœ… æ˜¯å¦æœ‰å¤šå±‚è·¯ç”±å™¨ï¼Ÿï¼ˆå…‰çŒ«éœ€è¦æ¡¥æŽ¥æ¨¡å¼ï¼‰

### Q2: å¦‚ä½•æŸ¥çœ‹æ˜¯å¦æœ‰å…¬ç½‘ IPï¼Ÿ

```bash
# æŸ¥çœ‹å…¬ç½‘ IP
curl ifconfig.me

# åœ¨è·¯ç”±å™¨ç®¡ç†ç•Œé¢æŸ¥çœ‹ WAN IP
# å¦‚æžœæ˜¯ 10.x.x.x æˆ– 100.x.x.xï¼Œåˆ™ä¸æ˜¯å…¬ç½‘ IP
```

### Q3: æ²¡æœ‰å…¬ç½‘ IP æ€Žä¹ˆåŠžï¼Ÿ

- è”ç³»è¿è¥å•†ç”³è¯·å…¬ç½‘ IPï¼ˆå¯èƒ½éœ€è¦é¢å¤–è´¹ç”¨ï¼‰
- ä½¿ç”¨å†…ç½‘ç©¿é€å·¥å…·ï¼ˆfrpã€ngrokã€CloudFlare Tunnelï¼‰
- ç§Ÿç”¨äº‘æœåŠ¡å™¨ä¸­è½¬

### Q4: å¦‚ä½•ç¡®ä¿æœåŠ¡å®‰å…¨ï¼Ÿ

1. æ·»åŠ  API Key è®¤è¯
2. ä½¿ç”¨ HTTPS
3. é…ç½® Nginx é™åˆ¶è®¿é—® IP
4. ä½¿ç”¨ VPN
5. å®šæœŸæ›´æ–°æœåŠ¡

---

éœ€è¦æˆ‘å¸®ä½ é…ç½®å“ªä¸ªæ–¹æ¡ˆå—ï¼ŸðŸ˜Š

